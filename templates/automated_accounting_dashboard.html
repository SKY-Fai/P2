{% extends "base.html" %}

{% block title %}AI Accounting - F-AI Accountant{% endblock %}

{% block extra_head %}
<!-- Dashboard Navigation Function - Load Immediately -->
<script>
window.openDashboardTab = function() {
    console.log('Dashboard button clicked - navigating...');
    try {
        window.location.href = '/bank-reconciliation-dashboard';
    } catch (error) {
        console.error('Navigation error:', error);
        alert('Error opening dashboard. Please try again.');
    }
};
</script>

<style>
    :root {
        /* Black & White Theme with Lightest Blue Background */
        --lightest-blue: #f0f8ff;
        --pure-black: #000000;
        --pure-white: #ffffff;
        --light-gray: #f5f5f5;
        --border-gray: #dddddd;
        --dark-gray: #333333;
        --text-black: #000000;
        --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.1);
        --radius: 8px;
        --radius-lg: 12px;
    }

    /* Page Layout */
    body {
        background: var(--lightest-blue) !important;
    }

    .dashboard-container {
        background: var(--lightest-blue);
        min-height: 100vh;
        padding: 2rem 0;
    }

    /* Card Styling */
    .card {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-subtle);
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }

    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .card-header {
        background: var(--pure-black) !important;
        border-bottom: 1px solid var(--border-gray);
        color: var(--pure-white) !important;
        font-weight: 700;
        padding: 1.5rem;
    }

    .card-header h3, .card-header h5 {
        color: var(--pure-white) !important;
    }

    .card-header .opacity-75 {
        color: rgba(255, 255, 255, 0.75) !important;
    }

    .card-body {
        background: var(--pure-white);
        padding: 1.5rem;
        color: var(--text-black);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-black);
        margin-bottom: 0.5rem;
    }

    .section-subtitle {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
    }

    /* Template Cards Styling */
    .template-card {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-subtle);
    }

    .template-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .template-type {
        font-weight: 700;
        color: var(--text-black);
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .template-desc {
        font-size: 0.9rem;
        color: var(--dark-gray);
        margin-bottom: 1rem;
    }

    /* Button Styling */
    .btn {
        font-weight: 600;
        border-radius: var(--radius);
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: var(--pure-black);
        border-color: var(--pure-black);
        color: var(--pure-white);
    }

    .btn-primary:hover {
        background: var(--dark-gray);
        border-color: var(--dark-gray);
        color: var(--pure-white);
    }

    .btn-outline-primary {
        color: var(--text-black);
        border-color: var(--text-black);
        background: var(--pure-white);
    }

    .btn-outline-primary:hover {
        background: var(--text-black);
        border-color: var(--text-black);
        color: var(--pure-white);
    }

    .btn-success {
        background: var(--pure-black);
        border-color: var(--pure-black);
        color: var(--pure-white);
    }

    .btn-success:hover {
        background: var(--dark-gray);
        border-color: var(--dark-gray);
    }

    .btn-outline-success {
        color: var(--text-black);
        border-color: var(--text-black);
        background: var(--pure-white);
    }

    .btn-outline-success:hover {
        background: var(--text-black);
        border-color: var(--text-black);
        color: var(--pure-white);
    }

    .btn-outline-info {
        color: var(--text-black);
        border-color: var(--text-black);
        background: var(--pure-white);
    }

    .btn-outline-info:hover {
        background: var(--text-black);
        border-color: var(--text-black);
        color: var(--pure-white);
    }

    /* Table Styling */
    .table thead th {
        background: var(--pure-black);
        color: var(--pure-white);
        border-color: var(--border-gray);
    }

    .table tbody {
        background: var(--pure-white);
        color: var(--text-black);
    }

    /* Progress bars */
    .progress {
        background: var(--light-gray);
        border-radius: var(--radius);
    }

    /* Form styling */
    .form-control, .form-select {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        color: var(--text-black);
        border-radius: var(--radius);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--text-black);
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
        background: var(--pure-white);
        color: var(--text-black);
    }

    /* Dashboard specific styling */
    .feature-stat h6 {
        color: var(--text-black);
        font-weight: 700;
    }

    .list-unstyled li {
        color: var(--text-black);
        padding: 0.25rem 0;
    }

    /* Alert styling */
    .alert-success {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        color: var(--text-black);
    }

    /* Badge styling */
    .badge {
        background: var(--pure-black);
        color: var(--pure-white);
    }

    /* Text colors */
    .text-success {
        color: var(--text-black) !important;
    }

    .text-muted {
        color: var(--dark-gray) !important;
    }

    /* Override Bootstrap header colors */
    .bg-primary {
        background-color: var(--pure-black) !important;
    }

    .bg-success {
        background-color: var(--pure-black) !important;
    }

    .bg-info {
        background-color: var(--pure-black) !important;
    }

    .bg-warning {
        background-color: var(--pure-black) !important;
        color: var(--pure-white) !important;
    }

    .bg-secondary {
        background-color: var(--pure-black) !important;
    }

    /* Border colors */
    .border-primary {
        border-color: var(--border-gray) !important;
    }

    .border-success {
        border-color: var(--border-gray) !important;
    }

    /* Professional monochrome design */
    h1, h2, h3, h4, h5, h6 {
        color: var(--text-black);
    }

    p {
        color: var(--text-black);
    }

    /* Icon colors */
    .fas, .fa {
        color: inherit;
    }

    /* Bank Reconciliation Styles */
    .reconciliation-stat {
        padding: 1rem;
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--dark-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-matched {
        background: var(--light-gray);
        color: var(--text-black);
        border: 1px solid var(--border-gray);
    }

    .status-partial {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: 1px solid var(--border-gray);
    }

    .status-unmatched {
        background: var(--light-gray);
        color: var(--text-black);
        border: 1px solid var(--text-black);
    }

    .confidence-score {
        display: inline-block;
        width: 60px;
        height: 6px;
        background: var(--light-gray);
        border-radius: 3px;
        position: relative;
        overflow: hidden;
    }

    .confidence-score::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: var(--confidence);
        background: var(--text-black);
        border-radius: 3px;
    }

    /* Manual Journal Entry Styles */
    .journal-entry-row {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid var(--border-gray);
        border-radius: var(--radius);
        background: var(--pure-white);
    }

    .journal-entry-row:hover {
        background: var(--light-gray);
    }

    .summary-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-gray);
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .amount-credit {
        color: var(--text-black);
        font-weight: 600;
    }

    .amount-debit {
        color: var(--dark-gray);
        font-weight: 600;
    }

    /* Form Controls Enhancement */
    .form-control, .form-select {
        background: var(--pure-white);
        border: 1px solid var(--text-black);
        color: var(--text-black);
        border-radius: var(--radius);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--text-black);
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
        background: var(--pure-white);
        color: var(--text-black);
    }

    /* Table Styling */
    .table {
        color: var(--text-black);
        background: var(--pure-white);
    }

    .table thead th {
        background: var(--pure-black);
        color: var(--pure-white);
        border-color: var(--border-gray);
    }

    .table tbody tr {
        border-color: var(--border-gray);
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background: var(--light-gray);
    }

    /* Alert Styling */
    .alert {
        border: 1px solid var(--border-gray);
        border-radius: var(--radius);
    }

    .alert-success {
        background: var(--light-gray);
        color: var(--text-black);
        border-color: var(--text-black);
    }

    .alert-warning {
        background: var(--light-gray);
        color: var(--dark-gray);
        border-color: var(--dark-gray);
    }

    .alert-info {
        background: var(--light-gray);
        color: var(--text-black);
        border-color: var(--border-gray);
    }

    .alert-danger {
        background: var(--light-gray);
        color: var(--text-black);
        border-color: var(--text-black);
    }

    /* Progress Bar */
    .progress {
        background: var(--light-gray);
        border: 1px solid var(--border-gray);
    }

    .progress-bar {
        background: var(--text-black);
    }

    /* Spinner */
    .spinner-border {
        color: var(--text-black);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="text-center">
                    <h1 class="section-title">AI Accounting Dashboard</h1>
                    <p class="section-subtitle">Intelligent Financial Data Processing & Report Generation</p>
                </div>
            </div>
        </div>

        <!-- Main Upload & Processing Hub -->
        <div class="row mb-5" id="automated-processing">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-upload me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Data Upload & Processing Hub</h3>
                                <p class="mb-0 opacity-75">Choose your preferred upload method for financial data processing</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Invoice-Inventory-GST Integration Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">
                                            <i class="fas fa-magic me-2"></i>Integrated Invoice-Inventory-GST Workflow
                                        </h5>
                                        <small>Automated template mapping for AR/AP/BR with instant journal report generation</small>
                                    </div>
                                    <div class="card-body">
                                        <!-- Workflow Steps -->
                                        <div class="workflow-steps mb-4">
                                            <div class="row text-center">
                                                <div class="col-md-3">
                                                    <div class="workflow-step">
                                                        <div class="step-icon bg-primary text-white">1</div>
                                                        <h6 class="mt-2">Template Upload</h6>
                                                        <small class="text-muted">Upload invoice/inventory/GST data</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="workflow-step">
                                                        <div class="step-icon bg-success text-white">2</div>
                                                        <h6 class="mt-2">Auto-Mapping</h6>
                                                        <small class="text-muted">AR/AP/BR classification</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="workflow-step">
                                                        <div class="step-icon bg-info text-white">3</div>
                                                        <h6 class="mt-2">Journal Creation</h6>
                                                        <small class="text-muted">Automated journal entries</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="workflow-step">
                                                        <div class="step-icon bg-warning text-dark">4</div>
                                                        <h6 class="mt-2">Reports Ready</h6>
                                                        <small class="text-muted">Comprehensive reports</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Integration Form -->
                                        <div class="row">
                                            <div class="col-lg-8">
                                                <form id="integratedWorkflowForm" enctype="multipart/form-data">
                                                    <div class="mb-3">
                                                        <label for="integratedFile" class="form-label">Upload Template File</label>
                                                        <input type="file" class="form-control" id="integratedFile" name="file" accept=".xlsx,.xls,.csv" required>
                                                        <div class="form-text">System automatically detects AR/AP/BR transactions and maps accordingly</div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="workflowType" class="form-label">Workflow Type</label>
                                                        <select class="form-select" id="workflowType" name="workflow_type">
                                                            <option value="automated" selected>Fully Automated (Recommended)</option>
                                                            <option value="manual">Manual Review Required</option>
                                                            <option value="combined">Combined Automated + Manual</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <button type="submit" class="btn btn-warning btn-lg">
                                                        <i class="fas fa-magic me-2"></i>Start Integrated Workflow
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="showIntegrationDemo()">
                                                        <i class="fas fa-play me-1"></i>View Demo
                                                    </button>
                                                </form>
                                                
                                                <script>
                                                // Handle integrated workflow form submission
                                                document.getElementById('integratedWorkflowForm').addEventListener('submit', function(e) {
                                                    e.preventDefault();
                                                    
                                                    const formData = new FormData(this);
                                                    const submitBtn = this.querySelector('button[type="submit"]');
                                                    const originalText = submitBtn.innerHTML;
                                                    
                                                    // Show loading state
                                                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Integration...';
                                                    submitBtn.disabled = true;
                                                    
                                                    fetch('/api/integrated-workflow/process', {
                                                        method: 'POST',
                                                        body: formData
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        if (data.success) {
                                                            showIntegratedResults(data);
                                                        } else {
                                                            showAlert('Error: ' + (data.error || 'Processing failed'), 'danger');
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('Error:', error);
                                                        showAlert('Network error occurred. Please try again.', 'danger');
                                                    })
                                                    .finally(() => {
                                                        submitBtn.innerHTML = originalText;
                                                        submitBtn.disabled = false;
                                                    });
                                                });
                                                
                                                function showIntegratedResults(data) {
                                                    const alert = document.createElement('div');
                                                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                                                    alert.innerHTML = `
                                                        <strong>Integration Complete!</strong>
                                                        <ul class="mb-0 mt-2">
                                                            <li>AR Transactions: ${data.integration_summary?.ar_transactions || 0}</li>
                                                            <li>AP Transactions: ${data.integration_summary?.ap_transactions || 0}</li>
                                                            <li>Bank Transactions: ${data.integration_summary?.bank_transactions || 0}</li>
                                                            <li>Journal Reports Generated: ${data.journal_reports_generated || 0}</li>
                                                        </ul>
                                                        <button type="button" class="btn btn-sm btn-success mt-2" onclick="window.location.href='/api/download-integrated-reports/excel'">
                                                            <i class="fas fa-download me-1"></i>Download Reports
                                                        </button>
                                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                    `;
                                                    
                                                    // Insert after the form
                                                    document.getElementById('integratedWorkflowForm').parentNode.appendChild(alert);
                                                }
                                                
                                                function showIntegrationDemo() {
                                                    const demoAlert = document.createElement('div');
                                                    demoAlert.className = 'alert alert-info alert-dismissible fade show mt-3';
                                                    demoAlert.innerHTML = `
                                                        <h6 class="alert-heading">Integration Demo</h6>
                                                        <p><strong>How it works:</strong></p>
                                                        <ol>
                                                            <li>Upload template with invoice/inventory/GST data</li>
                                                            <li>System automatically detects AR (sales), AP (purchases), BR (bank) transactions</li>
                                                            <li>Creates appropriate journal entries following double-entry principles</li>
                                                            <li>Generates comprehensive reports package</li>
                                                        </ol>
                                                        <p class="mb-0"><strong>Example:</strong> Customer invoice data â†’ AR mapping â†’ Debit: Accounts Receivable, Credit: Sales Revenue</p>
                                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                    `;
                                                    
                                                    // Insert after the form
                                                    document.getElementById('integratedWorkflowForm').parentNode.appendChild(demoAlert);
                                                }
                                                </script>
                                                </form>
                                            </div>
                                            <div class="col-lg-4">
                                                <div class="integration-features">
                                                    <h6 class="mb-3">Integration Benefits</h6>
                                                    <ul class="list-unstyled">
                                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Automatic AR/AP/BR detection</li>
                                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>GST portal integration</li>
                                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Inventory tracking</li>
                                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Real-time journal creation</li>
                                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Comprehensive reports</li>
                                                    </ul>
                                                    
                                                    <div class="alert alert-info mt-3">
                                                        <small><strong>How it works:</strong> The system analyzes your template columns to automatically identify sales (AR), purchases (AP), and bank transactions (BR), then creates appropriate journal entries and generates comprehensive reports.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-4">
                            <!-- Quick Upload Panel -->
                            <div class="col-lg-6">
                                <div class="card border-primary h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-bolt me-2"></i>Quick Upload
                                        </h5>
                                        <small class="opacity-75">Single file processing</small>
                                    </div>
                                    <div class="card-body">
                                        <form id="uploadForm" enctype="multipart/form-data">
                                            <div class="mb-3">
                                                <label for="templateType" class="form-label">Template Type</label>
                                                <select class="form-select" id="templateType" name="template_type" required>
                                                    <option value="">Select template type</option>
                                                    <option value="purchase">Purchase</option>
                                                    <option value="sales">Sales</option>
                                                    <option value="income">Income</option>
                                                    <option value="expense">Expense</option>
                                                    <option value="credit_note">Credit Note</option>
                                                    <option value="debit_note">Debit Note</option>
                                                    <option value="payroll">Payroll</option>
                                                    <option value="bank_transfer">Bank Transfer</option>
                                                    <option value="asset_purchase">Asset Purchase</option>
                                                    <option value="others">Others</option>
                                                    <option value="comprehensive_merged">Comprehensive Merged Template</option>
                                                    <option value="combined_all">Combined All Templates</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="fileUpload" class="form-label">Upload File</label>
                                                <input type="file" class="form-control" id="fileUpload" name="file" accept=".xlsx,.xls,.csv" required>
                                                <div class="form-text">Supported formats: Excel (.xlsx, .xls) and CSV (.csv)</div>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                                <i class="fas fa-cogs me-2"></i>Process & Generate Complete Package
                                            </button>
                                        </form>
                                        
                                        <!-- Individual Report Generation -->
                                        <div class="mt-4">
                                            <h6 class="mb-3">Individual Report Generation</h6>
                                            <p class="text-muted small mb-3">Generate specific reports individually after uploading data</p>
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('journal')">
                                                        <i class="fas fa-book me-1"></i>Journal Report
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('ledger')">
                                                        <i class="fas fa-list me-1"></i>Ledger Report
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('trial_balance')">
                                                        <i class="fas fa-balance-scale me-1"></i>Trial Balance
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('profit_loss')">
                                                        <i class="fas fa-chart-pie me-1"></i>P&L Statement
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('balance_sheet')">
                                                        <i class="fas fa-chart-area me-1"></i>Balance Sheet
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('cash_flow')">
                                                        <i class="fas fa-money-bill-wave me-1"></i>Cash Flow Statement
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="generateIndividualReport('shareholders_equity')">
                                                        <i class="fas fa-users me-1"></i>Shareholders' Equity
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button class="btn btn-outline-success btn-sm w-100" onclick="generateIndividualReport('mis_report')">
                                                        <i class="fas fa-analytics me-1"></i>MIS Report + Analysis
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Interaction Link Panel -->
                            <div class="col-lg-6">
                                <div class="card border-success h-100">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-folder-open me-2"></i>File Interaction
                                        </h5>
                                        <small class="opacity-75">Organized bulk folder processing</small>
                                    </div>
                                    <div class="card-body text-center py-5">
                                        <div class="mb-4">
                                            <i class="fas fa-folder-open fa-4x text-success mb-3"></i>
                                        </div>
                                        <h4 class="mb-3">Professional Data Organization</h4>
                                        <p class="text-muted mb-4">
                                            Access the organized upload system for bulk folder processing.<br>
                                            Upload files to categorized folders for streamlined analysis.
                                        </p>
                                        <div class="mb-4">
                                            <div class="row text-center">
                                                <div class="col-md-4">
                                                    <div class="feature-stat">
                                                        <h6 class="mb-1 text-success">6+ Categories</h6>
                                                        <small class="text-muted">Organized Folders</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="feature-stat">
                                                        <h6 class="mb-1 text-success">Bulk Processing</h6>
                                                        <small class="text-muted">Multiple Files</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="feature-stat">
                                                        <h6 class="mb-1 text-success">Auto-Classification</h6>
                                                        <small class="text-muted">Smart Analysis</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="{{ url_for('main.file_interaction') }}" class="btn btn-success btn-lg">
                                            <i class="fas fa-folder-open me-2"></i>Open File Interaction Center
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress and Results Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <!-- Progress Bar -->
                                <div id="progressSection" style="display: none;">
                                    <div class="progress mb-3">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div id="progressText" class="text-center">Processing...</div>
                                </div>

                                <!-- Results Section -->
                                <div id="resultsSection" style="display: none;">
                                    <div class="alert alert-success">
                                        <h5><i class="fas fa-check-circle me-2"></i>Processing Complete!</h5>
                                        <div id="resultsSummary"></div>
                                    </div>
                                    
                                    <div class="row" id="reportsGrid">
                                        <!-- Reports will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Comprehensive Report Generation Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Comprehensive Report Generation</h3>
                                <p class="mb-0 opacity-75">Generate complete financial reports package with MIS analysis</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Reports Overview Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="reports-overview">
                                    <h5 class="mb-3">ðŸ“Š Included Reports</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <ul class="list-unstyled mb-0">
                                                <li><i class="fas fa-check text-success me-2"></i>Journal Report</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Ledger Report</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Trial Balance</li>
                                                <li><i class="fas fa-check text-success me-2"></i>P&L Statement</li>
                                            </ul>
                                        </div>
                                        <div class="col-6">
                                            <ul class="list-unstyled mb-0">
                                                <li><i class="fas fa-check text-success me-2"></i>Balance Sheet</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Cash Flow Statement</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Shareholders' Equity</li>
                                                <li><i class="fas fa-star text-warning me-2"></i><strong>MIS Report + Analysis</strong></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="download-formats">
                                    <h5 class="mb-3">ðŸ’¾ Download Options</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="downloadAllReports('excel')">
                                            <i class="fas fa-file-excel me-2"></i>Download Excel Package
                                        </button>
                                        <button class="btn btn-primary" onclick="downloadAllReports('word')">
                                            <i class="fas fa-file-word me-2"></i>Download Word Package
                                        </button>
                                        <button class="btn btn-danger" onclick="downloadAllReports('pdf')">
                                            <i class="fas fa-file-pdf me-2"></i>Download PDF Package
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Generate Reports Button -->
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-primary btn-lg" onclick="generateCompleteReports()">
                                <i class="fas fa-file-archive me-2"></i>Generate Complete Package
                                <small class="d-block mt-1">All reports in Excel, PDF & Word formats</small>
                            </button>
                        </div>
                        
                        <!-- Processing Status -->
                        <div id="reportProcessingStatus" style="display: none;">
                            <div class="progress mb-3">
                                <div id="reportProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="reportProgressText" class="text-center">Generating reports...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Manual Journal Entry Module with Complete Workflow -->
        <div class="row mb-5" id="manual-journal">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-pen-to-square me-3 fs-4"></i>
                                <div>
                                    <h3 class="mb-1">Manual Journal Entry</h3>
                                    <p class="mb-0 opacity-75">Complete workflow: Create â†’ Edit â†’ Review â†’ Approve â†’ Post with real-time integration</p>
                                </div>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="showJournalList()">
                                    <i class="fas fa-list me-1"></i>View All
                                </button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="showPostingTracker()">
                                    <i class="fas fa-eye me-1"></i>Posted Entries
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Chart of Accounts Quick Reference -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card bg-light border">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list-alt me-2"></i>Chart of Accounts Quick Reference
                                            <button class="btn btn-sm btn-outline-primary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#coaReference">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </h6>
                                    </div>
                                    <div class="collapse" id="coaReference">
                                        <div class="card-body py-2">
                                            <div class="row">
                                                <div class="col-md-2">
                                                    <strong class="text-primary">Assets (1000s)</strong>
                                                    <small class="d-block">1000: Cash & Bank</small>
                                                    <small class="d-block">1100: Receivables</small>
                                                    <small class="d-block">1200: Inventory</small>
                                                    <small class="d-block">1400: Fixed Assets</small>
                                                </div>
                                                <div class="col-md-2">
                                                    <strong class="text-danger">Liabilities (2000s)</strong>
                                                    <small class="d-block">2000: Current Liab.</small>
                                                    <small class="d-block">2100: Long-term Liab.</small>
                                                    <small class="d-block">2200: Tax Liabilities</small>
                                                </div>
                                                <div class="col-md-2">
                                                    <strong class="text-info">Equity (3000s)</strong>
                                                    <small class="d-block">3000: Owner's Equity</small>
                                                    <small class="d-block">3010: Share Capital</small>
                                                    <small class="d-block">3020: Retained Earnings</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong class="text-success">Revenue (4000s)</strong>
                                                    <small class="d-block">4000: Sales Revenue</small>
                                                    <small class="d-block">4010: Product Sales</small>
                                                    <small class="d-block">4100: Other Income</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong class="text-warning">Expenses (5000s)</strong>
                                                    <small class="d-block">5000: COGS</small>
                                                    <small class="d-block">5100: Operating Exp.</small>
                                                    <small class="d-block">5200: Financial Exp.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4">
                            <!-- Journal Entry Form -->
                            <div class="col-md-8">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-edit me-2"></i>Create Journal Entry
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="manualJournalForm">
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="journalDate" class="form-label">Entry Date</label>
                                                    <input type="date" class="form-control" id="journalDate" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="journalReference" class="form-label">Reference Number</label>
                                                    <input type="text" class="form-control" id="journalReference" placeholder="Auto-generated">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="journalType" class="form-label">Journal Type</label>
                                                    <select class="form-select" id="journalType">
                                                        <option value="general">General Journal</option>
                                                        <option value="adjusting">Adjusting Entry</option>
                                                        <option value="closing">Closing Entry</option>
                                                        <option value="reversing">Reversing Entry</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="journalDescription" class="form-label">Journal Description</label>
                                                <input type="text" class="form-control" id="journalDescription" placeholder="Enter detailed description of the transaction" required>
                                            </div>
                                            
                                            <!-- Accounting Rules Alert -->
                                            <div class="alert alert-info mb-3">
                                                <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Accounting Rules Reminder</h6>
                                                <small>
                                                    <strong>Assets & Expenses:</strong> Increase with Debits, Decrease with Credits | 
                                                    <strong>Liabilities, Equity & Revenue:</strong> Increase with Credits, Decrease with Debits | 
                                                    <strong>Total Debits must equal Total Credits</strong>
                                                </small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label mb-0">Journal Entries</label>
                                                    <div>
                                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="addJournalEntry">
                                                            <i class="fas fa-plus me-1"></i>Add Entry
                                                        </button>
                                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="loadCommonTemplates()">
                                                            <i class="fas fa-templates me-1"></i>Templates
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Headers -->
                                                <div class="row g-2 mb-2 border-bottom pb-2">
                                                    <div class="col-md-3"><small class="text-muted fw-bold">Account Code & Name</small></div>
                                                    <div class="col-md-3"><small class="text-muted fw-bold">Description</small></div>
                                                    <div class="col-md-2"><small class="text-muted fw-bold">Debit (â‚¹)</small></div>
                                                    <div class="col-md-2"><small class="text-muted fw-bold">Credit (â‚¹)</small></div>
                                                    <div class="col-md-1"><small class="text-muted fw-bold">Effect</small></div>
                                                    <div class="col-md-1"><small class="text-muted fw-bold">Action</small></div>
                                                </div>
                                                
                                                <div id="journalEntries">
                                                    <!-- Initial entry row -->
                                                    <div class="journal-entry-row row g-2 mb-2" data-entry="1">
                                                        <div class="col-md-3">
                                                            <div class="position-relative">
                                                                <input type="text" class="form-control account-search" name="account_code[]" placeholder="Search account code or name..." autocomplete="off" required>
                                                                <div class="account-dropdown position-absolute w-100 bg-white border border-top-0 rounded-bottom d-none" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                                    <!-- Account suggestions will be populated here -->
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-success position-absolute end-0 top-0" style="margin: 2px;" onclick="showCreateAccountModal(this)" title="Create New Account">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control" name="description[]" placeholder="Description" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control debit-amount" name="debit_amount[]" placeholder="0.00" step="0.01" min="0">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control credit-amount" name="credit_amount[]" placeholder="0.00" step="0.01" min="0">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <small class="accounting-effect text-muted">-</small>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-outline-danger btn-sm remove-entry" disabled>
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <button type="submit" class="btn btn-success w-100">
                                                        <i class="fas fa-save me-2"></i>Save Entry
                                                    </button>
                                                </div>
                                                <div class="col-md-4">
                                                    <button type="button" class="btn btn-outline-secondary w-100" id="validateJournal">
                                                        <i class="fas fa-check me-2"></i>Validate Rules
                                                    </button>
                                                </div>
                                                <div class="col-md-4">
                                                    <button type="button" class="btn btn-outline-danger w-100" onclick="clearJournalForm()">
                                                        <i class="fas fa-trash me-2"></i>Clear All
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Journal Entry Summary & Validation -->
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-calculator me-2"></i>Entry Summary
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="summary-item">
                                            <div class="d-flex justify-content-between">
                                                <span>Total Debits:</span>
                                                <span id="totalDebits" class="amount-debit fw-bold">â‚¹0.00</span>
                                            </div>
                                        </div>
                                        <div class="summary-item">
                                            <div class="d-flex justify-content-between">
                                                <span>Total Credits:</span>
                                                <span id="totalCredits" class="amount-credit fw-bold">â‚¹0.00</span>
                                            </div>
                                        </div>
                                        <div class="summary-item">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-bold">Balance:</span>
                                                <span id="entryBalance" class="fw-bold text-success">â‚¹0.00</span>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            <span id="entryCount">1</span> entries
                                        </small>
                                        
                                        <div id="validationStatus" class="mt-3">
                                            <div class="alert alert-info py-2" role="alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>Add at least 2 entries to validate</small>
                                            </div>
                                        </div>
                                        
                                        <div id="accountingRulesStatus" class="mt-2">
                                            <!-- Real-time accounting rules validation will appear here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Journal Entry Results -->
                        <div id="journalResults" class="mt-4" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Journal Entry Created Successfully</h6>
                                </div>
                                <div class="card-body">
                                    <div id="journalSummary"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Workflow Management Interface -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>Journal Entry Workflow Management
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Workflow Action Buttons -->
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="createNewJournal()">
                                                    <i class="fas fa-plus me-1"></i>Create
                                                </button>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="editSelectedJournal()">
                                                    <i class="fas fa-edit me-1"></i>Edit
                                                </button>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="reviewSelectedJournal()">
                                                    <i class="fas fa-search me-1"></i>Review
                                                </button>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="approveSelectedJournal()">
                                                    <i class="fas fa-check me-1"></i>Approve
                                                </button>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="rejectSelectedJournal()">
                                                    <i class="fas fa-times me-1"></i>Reject
                                                </button>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-dark btn-sm w-100" onclick="deleteSelectedJournal()">
                                                    <i class="fas fa-trash me-1"></i>Delete
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Journal Entries List -->
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="journalEntriesTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th width="5%">Select</th>
                                                        <th>Journal #</th>
                                                        <th>Date</th>
                                                        <th>Description</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                        <th>Created By</th>
                                                        <th>Workflow</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="journalEntriesTableBody">
                                                    <tr>
                                                        <td colspan="9" class="text-center text-muted py-3">
                                                            <i class="fas fa-info-circle me-2"></i>No journal entries found. Create your first entry above.
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- Quick Actions -->
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="refreshJournalList()">
                                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                                </button>
                                                <button type="button" class="btn btn-info btn-sm ms-2" onclick="showJournalFilters()">
                                                    <i class="fas fa-filter me-1"></i>Filter
                                                </button>
                                            </div>
                                            <div>
                                                <small class="text-muted">
                                                    <span id="journalCount">0</span> entries | 
                                                    <span id="pendingCount">0</span> pending review
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Floating Posted Entries Display -->
                        <div id="postedEntriesFloat" class="mt-4" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-check-double me-2"></i>Recent Posted Journal Entries
                                        </h6>
                                        <button type="button" class="btn btn-outline-light btn-sm" onclick="hidePostedEntriesFloat()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0" id="postedEntriesTable">
                                            <thead class="table-success">
                                                <tr>
                                                    <th>Journal #</th>
                                                    <th>Posted Date/Time</th>
                                                    <th>Description</th>
                                                    <th>Total Amount</th>
                                                    <th>Posted By</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="postedEntriesTableBody">
                                                <!-- Posted entries will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer text-center py-2">
                                        <small class="text-muted">
                                            Auto-refreshing every 30 seconds | Last updated: <span id="lastUpdated">--</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Report Generation Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-bar me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Individual Report Generation</h3>
                                <p class="mb-0 opacity-75">Generate specific financial reports individually</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('journal')">
                                    <i class="fas fa-book me-2"></i>
                                    <div>Journal Report</div>
                                    <small class="text-muted">Transaction entries</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('ledger')">
                                    <i class="fas fa-list-alt me-2"></i>
                                    <div>Ledger Report</div>
                                    <small class="text-muted">Account summaries</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('trial_balance')">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    <div>Trial Balance</div>
                                    <small class="text-muted">Balance verification</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('profit_loss')">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    <div>P&L Statement</div>
                                    <small class="text-muted">Income & expenses</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('balance_sheet')">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    <div>Balance Sheet</div>
                                    <small class="text-muted">Financial position</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('cash_flow')">
                                    <i class="fas fa-exchange-alt me-2"></i>
                                    <div>Cash Flow Statement</div>
                                    <small class="text-muted">Cash movements</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="generateIndividualReport('shareholders_equity')">
                                    <i class="fas fa-users me-2"></i>
                                    <div>Shareholders' Equity</div>
                                    <small class="text-muted">Equity changes</small>
                                </button>
                            </div>
                            
                            <div class="col-md-6 col-lg-3">
                                <button type="button" class="btn btn-outline-success w-100 h-100" onclick="generateIndividualReport('mis_report')">
                                    <i class="fas fa-analytics me-2"></i>
                                    <div>MIS Report</div>
                                    <small class="text-muted">Management analysis</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Bank Reconciliation Module -->
    <div class="row mb-5" id="bank-reconciliation">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-info text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-university me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Bank Reconciliation</h3>
                                <p class="mb-0 opacity-75">Automated bank statement matching and reconciliation</p>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="opacity-75">Smart Transaction Matching</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Bank Statement Upload Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-upload text-info me-2"></i>
                                        Upload Bank Statement
                                    </h5>
                                    <p class="card-text">Upload your bank statement for automated reconciliation</p>
                                    <form id="bankStatementForm" action="/api/bank-reconciliation" method="post" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label for="bankStatement" class="form-label">Bank Statement File</label>
                                            <input type="file" class="form-control" id="bankStatement" name="bank_statement" 
                                                   accept=".xlsx,.xls,.csv" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="bankAccount" class="form-label">Bank Account</label>
                                            <select class="form-select" id="bankAccount" name="bank_account" required>
                                                <option value="">Select Bank Account</option>
                                                <option value="MAIN_CURRENT">Main Current Account</option>
                                                <option value="SAVINGS">Savings Account</option>
                                                <option value="CASH_CREDIT">Cash Credit Account</option>
                                                <option value="OVERDRAFT">Overdraft Account</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reconciliationDate" class="form-label">Reconciliation Date</label>
                                            <input type="date" class="form-control" id="reconciliationDate" name="reconciliation_date" required>
                                        </div>
                                        <button type="submit" class="btn btn-info">
                                            <i class="fas fa-sync me-2"></i>Start Reconciliation
                                        </button>
                                        <button type="button" class="btn btn-success ms-2" onclick="openDashboardTab()">
                                            <i class="fas fa-tachometer-alt me-2"></i>Try Dashboard
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-chart-bar text-success me-2"></i>
                                        Reconciliation Dashboard
                                    </h5>
                                    <p class="card-text">View comprehensive reconciliation dashboard with transaction analysis</p>
                                    <button type="button" class="btn btn-success btn-lg" onclick="openDashboardTab()">
                                        <i class="fas fa-tachometer-alt me-2"></i>Try Dashboard
                                    </button>
                                    <div id="reconciliationStatus">
                                        <p class="text-muted">No reconciliation in progress</p>
                                    </div>
                                    <div id="reconciliationResults" style="display: none;">
                                        <div class="row text-center mb-3">
                                            <div class="col-3">
                                                <div class="reconciliation-stat">
                                                    <h4 class="text-success" id="matchedCount">0</h4>
                                                    <small>Matched</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="reconciliation-stat">
                                                    <h4 class="text-warning" id="unmatchedCount">0</h4>
                                                    <small>Unmatched</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="reconciliation-stat">
                                                    <h4 class="text-danger" id="doubtfulCount">0</h4>
                                                    <small>Doubtful</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="reconciliation-stat">
                                                    <h4 class="text-info" id="totalCount">0</h4>
                                                    <small>Total</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-success" role="progressbar" id="reconciliationProgress" 
                                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="text-center">
                                            <button class="btn btn-sm btn-outline-primary" onclick="refreshReconciliation()">
                                                <i class="fas fa-refresh me-1"></i>Refresh
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="exportReconciliation()">
                                                <i class="fas fa-download me-1"></i>Export
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Reconciliation Dashboard -->
                    <div class="row mb-4" id="advancedReconciliationFeatures" style="display: none;">
                        
                        <!-- Reconciliation Status Overview -->
                        <div class="col-md-8 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Reconciliation Status Overview</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <canvas id="reconciliationChart" width="200" height="200"></canvas>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="reconciliation-stats">
                                                <div class="stat-item d-flex justify-content-between mb-2">
                                                    <span class="stat-label">AI Matches:</span>
                                                    <span class="stat-value badge bg-success" id="aiMatchCount">0</span>
                                                </div>
                                                <div class="stat-item d-flex justify-content-between mb-2">
                                                    <span class="stat-label">Manual Matches:</span>
                                                    <span class="stat-value badge bg-info" id="manualMatchCount">0</span>
                                                </div>
                                                <div class="stat-item d-flex justify-content-between mb-2">
                                                    <span class="stat-label">Exceptions:</span>
                                                    <span class="stat-value badge bg-warning" id="exceptionCount">0</span>
                                                </div>
                                                <div class="stat-item d-flex justify-content-between mb-2">
                                                    <span class="stat-label">Confidence Rate:</span>
                                                    <span class="stat-value badge bg-primary" id="confidenceRate">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Action Panel -->
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-warning" onclick="jumpToManualMatch()">
                                            <i class="fas fa-hand-point-right"></i> Jump to Manual Match
                                        </button>
                                        <button class="btn btn-danger" onclick="reviewExceptions()">
                                            <i class="fas fa-exclamation-triangle"></i> Review Exceptions
                                        </button>
                                        <button class="btn btn-info" onclick="viewAISuggestions()">
                                            <i class="fas fa-robot"></i> View AI Suggestions
                                        </button>
                                        <button class="btn btn-success" onclick="generateJournalEntries()">
                                            <i class="fas fa-plus"></i> Generate Journals
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mapped/Unmapped Summary with Filters -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-filter"></i> Transaction Summary & Filters</h5>
                                    <div class="summary-counters">
                                        <span class="badge bg-success me-2" id="matchedBadge">0 Matched</span>
                                        <span class="badge bg-warning me-2" id="unmatchedBadge">0 Unmatched</span>
                                        <span class="badge bg-danger" id="flaggedBadge">0 Flagged</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label>Filter by Status:</label>
                                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                                <option value="all">All Transactions</option>
                                                <option value="matched">Matched Only</option>
                                                <option value="unmatched">Unmatched Only</option>
                                                <option value="doubtful">Flagged Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label>Date From:</label>
                                            <input type="date" class="form-control" id="dateFromFilter" onchange="applyFilters()">
                                        </div>
                                        <div class="col-md-2">
                                            <label>Date To:</label>
                                            <input type="date" class="form-control" id="dateToFilter" onchange="applyFilters()">
                                        </div>
                                        <div class="col-md-2">
                                            <label>Min Amount:</label>
                                            <input type="number" class="form-control" id="amountFilter" placeholder="â‚¹ 0" onchange="applyFilters()">
                                        </div>
                                        <div class="col-md-3">
                                            <label>Account/Vendor:</label>
                                            <input type="text" class="form-control" id="vendorFilter" placeholder="Search..." onchange="applyFilters()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exceptions Alert Panel -->
                        <div class="col-12 mb-3" id="exceptionsAlert" style="display: none;">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Exceptions Requiring Review</h5>
                                </div>
                                <div class="card-body">
                                    <div id="exceptionsList">
                                        <div class="alert alert-warning">
                                            <strong>Duplicate Transaction:</strong> Amount â‚¹50,000 appears twice on 2024-01-15
                                        </div>
                                        <div class="alert alert-info">
                                            <strong>Currency Mismatch:</strong> USD transaction in INR bank account
                                        </div>
                                        <div class="alert alert-secondary">
                                            <strong>Partial Match:</strong> Invoice amount differs by â‚¹100
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Controls and Activity Log -->
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-layer-group"></i> Batch Controls</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label>Current Batch:</label>
                                        <select class="form-select" id="batchSelector">
                                            <option value="batch1">Batch 2024-01 (Active)</option>
                                            <option value="batch2">Batch 2024-02 (Locked)</option>
                                        </select>
                                    </div>
                                    <div class="btn-group w-100 mb-2" role="group">
                                        <button class="btn btn-success" onclick="lockBatch()">
                                            <i class="fas fa-lock"></i> Lock
                                        </button>
                                        <button class="btn btn-info" onclick="exportBatchReport()">
                                            <i class="fas fa-download"></i> Export
                                        </button>
                                        <button class="btn btn-danger" onclick="finalizeReconciliation()">
                                            <i class="fas fa-check-circle"></i> Finalize
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> Locked batches cannot be modified
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-history"></i> User Activity Log</h5>
                                </div>
                                <div class="card-body">
                                    <div id="activityLog" style="max-height: 200px; overflow-y: auto;">
                                        <div class="activity-item border-bottom pb-2 mb-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">2024-01-15 10:30</small>
                                                <span class="badge bg-warning">Manual</span>
                                            </div>
                                            <small>Admin manually mapped transaction #1234</small>
                                        </div>
                                        <div class="activity-item border-bottom pb-2 mb-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">2024-01-15 10:25</small>
                                                <span class="badge bg-success">AI</span>
                                            </div>
                                            <small>AI auto-matched 15 transactions</small>
                                        </div>
                                        <div class="activity-item border-bottom pb-2 mb-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">2024-01-15 10:20</small>
                                                <span class="badge bg-info">System</span>
                                            </div>
                                            <small>Batch 2024-01 created</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Transaction Matching Results -->
                    <div class="row mb-4" id="transactionMatchingResults" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list me-2"></i>Transaction Matching Results
                                        </h6>
                                        <div>
                                            <button class="btn btn-sm btn-outline-light" onclick="filterTransactions('all')">All</button>
                                            <button class="btn btn-sm btn-outline-light" onclick="filterTransactions('matched')">Matched</button>
                                            <button class="btn btn-sm btn-outline-light" onclick="filterTransactions('unmatched')">Unmatched</button>
                                            <button class="btn btn-sm btn-outline-light" onclick="filterTransactions('doubtful')">Doubtful</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="transactionTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Confidence</th>
                                                    <th>Matched Invoice</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transactionTableBody">
                                                <!-- Transactions will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Mapping Interface -->
                    <div class="row mb-4" id="manualMappingInterface" style="display: none;">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-edit me-2"></i>Manual Transaction Mapping
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-header">
                                                    <h6 class="mb-0">Bank Transaction</h6>
                                                </div>
                                                <div class="card-body" id="selectedTransaction">
                                                    <p class="text-muted">Select a transaction to map</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-header">
                                                    <h6 class="mb-0">Account Mapping</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Account Selection</label>
                                                        <select class="form-select" id="accountMapping">
                                                            <option value="">Select Account</option>
                                                            <option value="SALES_REVENUE">Sales Revenue</option>
                                                            <option value="OFFICE_EXPENSES">Office Expenses</option>
                                                            <option value="BANK_CHARGES">Bank Charges</option>
                                                            <option value="RENT_EXPENSE">Rent Expense</option>
                                                            <option value="UTILITIES">Utilities</option>
                                                            <option value="LOAN_PAYMENT">Loan Payment</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Description</label>
                                                        <input type="text" class="form-control" id="mappingDescription" 
                                                               placeholder="Enter transaction description">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Confidence Level</label>
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar" id="confidenceBar" 
                                                                 style="width: 0%"></div>
                                                        </div>
                                                        <small class="text-muted" id="confidenceText">Select account for analysis</small>
                                                    </div>
                                                    <button class="btn btn-success" onclick="performManualMapping()">
                                                        <i class="fas fa-save me-1"></i>Save Mapping
                                                    </button>
                                                    <button class="btn btn-secondary" onclick="cancelManualMapping()">
                                                        <i class="fas fa-times me-1"></i>Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reconciliation Report -->
                    <div class="row" id="reconciliationReport" style="display: none;">
                        <div class="col-12">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-alt me-2"></i>Reconciliation Report
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="text-success" id="reportMatchedAmount">â‚¹0.00</h5>
                                                    <small>Matched Amount</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="text-warning" id="reportUnmatchedAmount">â‚¹0.00</h5>
                                                    <small>Unmatched Amount</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="text-info" id="reportReconciliationDate">-</h5>
                                                    <small>Reconciliation Date</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="text-primary" id="reportAccountName">-</h5>
                                                    <small>Account</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <button class="btn btn-primary" onclick="downloadReconciliationReport()">
                                            <i class="fas fa-download me-1"></i>Download Report
                                        </button>
                                        <button class="btn btn-success" onclick="finalizeReconciliation()">
                                            <i class="fas fa-check me-1"></i>Finalize Reconciliation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Template Library Section (Moved to Bottom) -->
    <div class="row mb-5" id="templates">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-success text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-excel me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Template Library</h3>
                                <p class="mb-0 opacity-75">Download professional Excel templates for different transaction types</p>
                            </div>
                        </div>
                        <!-- Bulk Download Section -->
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="downloadBulkTemplates('excel')">
                                <i class="fas fa-download me-1"></i>All Excel
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="downloadBulkTemplates('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>All PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Templates Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-file me-2"></i>Template</th>
                                    <th><i class="fas fa-tag me-2"></i>Type</th>
                                    <th><i class="fas fa-info-circle me-2"></i>Description</th>
                                    <th><i class="fas fa-download me-2"></i>Download</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <i class="fas fa-shopping-cart text-primary me-2"></i>
                                        <strong>Purchase Template</strong>
                                    </td>
                                    <td><span class="badge bg-primary">Purchase</span></td>
                                    <td>Record purchase transactions with vendor details</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate('purchase')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-cash-register text-success me-2"></i>
                                        <strong>Sales Template</strong>
                                    </td>
                                    <td><span class="badge bg-success">Sales</span></td>
                                    <td>Track sales transactions and customer information</td>
                                    <td>
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadTemplate('sales')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-arrow-up text-info me-2"></i>
                                        <strong>Income Template</strong>
                                    </td>
                                    <td><span class="badge bg-info">Income</span></td>
                                    <td>Record various income sources and revenue</td>
                                    <td>
                                        <button class="btn btn-outline-info btn-sm" onclick="downloadTemplate('income')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-arrow-down text-warning me-2"></i>
                                        <strong>Expense Template</strong>
                                    </td>
                                    <td><span class="badge bg-warning">Expense</span></td>
                                    <td>Track business expenses and operational costs</td>
                                    <td>
                                        <button class="btn btn-outline-warning btn-sm" onclick="downloadTemplate('expense')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-credit-card text-danger me-2"></i>
                                        <strong>Credit Note Template</strong>
                                    </td>
                                    <td><span class="badge bg-danger">Credit</span></td>
                                    <td>Issue credit notes for returns and adjustments</td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" onclick="downloadTemplate('credit_note')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-receipt text-secondary me-2"></i>
                                        <strong>Debit Note Template</strong>
                                    </td>
                                    <td><span class="badge bg-secondary">Debit</span></td>
                                    <td>Create debit notes for additional charges</td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate('debit_note')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-users text-primary me-2"></i>
                                        <strong>Payroll Template</strong>
                                    </td>
                                    <td><span class="badge bg-primary">Payroll</span></td>
                                    <td>Manage employee payroll and benefits</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate('payroll')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-exchange-alt text-success me-2"></i>
                                        <strong>Bank Transfer Template</strong>
                                    </td>
                                    <td><span class="badge bg-success">Transfer</span></td>
                                    <td>Record bank transfers and fund movements</td>
                                    <td>
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadTemplate('bank_transfer')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-building text-info me-2"></i>
                                        <strong>Asset Purchase Template</strong>
                                    </td>
                                    <td><span class="badge bg-info">Asset</span></td>
                                    <td>Track asset purchases and depreciation</td>
                                    <td>
                                        <button class="btn btn-outline-info btn-sm" onclick="downloadTemplate('asset_purchase')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-ellipsis-h text-secondary me-2"></i>
                                        <strong>Other Transactions</strong>
                                    </td>
                                    <td><span class="badge bg-secondary">Others</span></td>
                                    <td>Miscellaneous transactions and adjustments</td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate('others')">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Featured Templates Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3">Featured Combined Templates</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-layer-group text-primary me-3 fs-4"></i>
                                                <div>
                                                    <h6 class="mb-1">Comprehensive Merged Template</h6>
                                                    <p class="mb-0 small text-muted">66 fields covering all transaction types</p>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary btn-sm mt-2" onclick="downloadTemplate('comprehensive_merged')">
                                                <i class="fas fa-download me-1"></i>Download
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-th-large text-success me-3 fs-4"></i>
                                                <div>
                                                    <h6 class="mb-1">Combined All Templates</h6>
                                                    <p class="mb-0 small text-muted">All transaction types in one package</p>
                                                </div>
                                            </div>
                                            <button class="btn btn-success btn-sm mt-2" onclick="downloadTemplate('combined_all')">
                                                <i class="fas fa-download me-1"></i>Download
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Financial Report Package Section -->
    <div class="row mb-5" id="financial-report-package">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-excel me-3 fs-2 text-warning"></i>
                            <div>
                                <h2 class="mb-1">Complete Financial Report Package</h2>
                                <p class="mb-0 opacity-90">All reports in separate sheets within one Excel file</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success fs-6 me-3">12 Reports</span>
                            <span class="badge bg-warning fs-6">One Excel File</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-check-circle me-2"></i>Included Reports
                                    </h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Balance Sheet</strong> - Assets, Liabilities & Equity
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Income Statement</strong> - Revenue & Expenses
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Cash Flow Statement</strong> - Operating, Investing & Financing
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Statement of Equity</strong> - Changes in Ownership
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Trial Balance</strong> - Account Balances Verification
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-success me-2"></i>
                                            <strong>Journal Entries</strong> - Transaction Details
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-plus-circle me-2"></i>Additional Features
                                    </h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Ledger Summary</strong> - Account-wise Details
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Ratio Analysis</strong> - Financial Performance Metrics
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Notes to Financial Statements</strong> - Explanatory Notes
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Management Discussion</strong> - Business Analysis
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Auditor Report</strong> - Independent Assessment
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-angle-right text-info me-2"></i>
                                            <strong>Cover Sheet</strong> - Company Information & Contents
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="bg-light rounded p-4 h-100 d-flex flex-column justify-content-center">
                                <div class="text-center mb-4">
                                    <i class="fas fa-download text-primary" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3 mb-3">Ready to Download</h4>
                                    <p class="text-muted">Professional Excel package with all financial reports</p>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-lg" onclick="downloadFinancialReportPackage()" id="downloadPackageBtn">
                                        <i class="fas fa-file-excel me-2"></i>
                                        Download Complete Package
                                    </button>
                                    <small class="text-muted text-center mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        IFRS & GAAP Compliant â€¢ INR Currency Format
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Reports Section (Moved to Bottom) -->
    <div class="row mb-5" id="sample-reports">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt me-3 fs-4"></i>
                            <div>
                                <h3 class="mb-1">Sample Reports</h3>
                                <p class="mb-0 opacity-75">Preview customized financial reports with client branding</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-light btn-sm" onclick="showKYCSetupModal()">
                            <i class="fas fa-cog me-1"></i>Setup KYC
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- KYC Status Display -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="kyc-status">KYC Setup: <strong>Default Template</strong> - Click "Setup KYC" to customize client branding</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Reports Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-file-alt me-2"></i>Report Type</th>
                                    <th><i class="fas fa-info-circle me-2"></i>Description</th>
                                    <th><i class="fas fa-download me-2"></i>Sample Preview</th>
                                    <th><i class="fas fa-palette me-2"></i>Customized Version</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <i class="fas fa-book text-primary me-2"></i>
                                        <strong>Journal Report</strong>
                                    </td>
                                    <td>Detailed transaction ledger with chronological entries</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('journal')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('journal')" disabled id="journal-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-list-alt text-success me-2"></i>
                                        <strong>Ledger Report</strong>
                                    </td>
                                    <td>Account-wise transaction summaries and balances</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('ledger')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('ledger')" disabled id="ledger-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-balance-scale text-warning me-2"></i>
                                        <strong>Trial Balance</strong>
                                    </td>
                                    <td>Balance verification with debit and credit totals</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('trial_balance')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('trial_balance')" disabled id="trial_balance-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-chart-pie text-info me-2"></i>
                                        <strong>P&L Statement</strong>
                                    </td>
                                    <td>Income and expense summary with profit analysis</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('profit_loss')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('profit_loss')" disabled id="profit_loss-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-clipboard-list text-danger me-2"></i>
                                        <strong>Balance Sheet</strong>
                                    </td>
                                    <td>Assets, liabilities, and equity financial position</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('balance_sheet')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('balance_sheet')" disabled id="balance_sheet-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-exchange-alt text-secondary me-2"></i>
                                        <strong>Cash Flow Statement</strong>
                                    </td>
                                    <td>Operating, investing, and financing cash movements</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('cash_flow')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('cash_flow')" disabled id="cash_flow-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <i class="fas fa-users text-primary me-2"></i>
                                        <strong>Shareholders' Equity</strong>
                                    </td>
                                    <td>Changes in equity and capital structure</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateSampleReport('shareholders_equity')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="generateCustomReport('shareholders_equity')" disabled id="shareholders_equity-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                                <tr class="table-success">
                                    <td>
                                        <i class="fas fa-analytics text-success me-2"></i>
                                        <strong>MIS Report</strong>
                                    </td>
                                    <td><strong>Management Information System with ratio analysis</strong></td>
                                    <td>
                                        <button class="btn btn-outline-success btn-sm" onclick="generateSampleReport('mis_report')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="generateCustomReport('mis_report')" disabled id="mis_report-custom">
                                            <i class="fas fa-magic me-1"></i>Generate
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard navigation function - IMMEDIATELY available
window.openDashboardTab = function() {
    console.log('Navigating to dashboard...');
    try {
        const dashboardUrl = '/bank-reconciliation-dashboard';
        console.log('Dashboard URL:', dashboardUrl);
        
        // Show loading indicator
        const buttons = document.querySelectorAll('button[onclick="openDashboardTab()"]');
        buttons.forEach(btn => {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading Dashboard...';
            btn.disabled = true;
        });
        
        // Add a small delay to ensure loading indicator is visible
        setTimeout(() => {
            // Navigate within the same page instead of opening popup
            window.location.href = dashboardUrl;
            console.log('Navigating to dashboard page');
        }, 200);
        
    } catch (error) {
        console.error('Error navigating to dashboard:', error);
        alert('Error navigating to dashboard. Please try again.');
        
        // Reset buttons on error
        const buttons = document.querySelectorAll('button[onclick="openDashboardTab()"]');
        buttons.forEach(btn => {
            btn.innerHTML = '<i class="fas fa-tachometer-alt me-2"></i>Try Dashboard';
            btn.disabled = false;
        });
    }
};

// Also define as regular function for compatibility
function openDashboardTab() {
    window.openDashboardTab();
}

// AI Accounting Dashboard Functions
function downloadTemplate(type) {
    window.location.href = `/download-accounting-template/${type}`;
}

function generateCompleteReports() {
    const statusSection = document.getElementById('reportProcessingStatus');
    const progressBar = document.getElementById('reportProgressBar');
    const progressText = document.getElementById('reportProgressText');
    
    statusSection.style.display = 'block';
    progressBar.style.width = '20%';
    progressText.textContent = 'Generating comprehensive reports...';
    
    setTimeout(() => {
        progressBar.style.width = '60%';
        progressText.textContent = 'Processing financial data...';
    }, 1000);
    
    setTimeout(() => {
        progressBar.style.width = '100%';
        progressText.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Reports generated successfully!';
        progressBar.classList.remove('progress-bar-animated');
    }, 2500);
}

function generateIndividualReport(reportType) {
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;
    
    // Check if data has been uploaded first
    if (!window.uploadedData) {
        alert('Please upload data first before generating individual reports.');
        button.innerHTML = originalContent;
        button.disabled = false;
        return;
    }
    
    // Generate individual report with multi-format options
    fetch(`/api/automated-accounting/individual-report`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            report_type: reportType,
            format: 'excel'
        })
    })
    .then(response => {
        if (response.ok) {
            // Show format selection for download
            showFormatSelection(reportType);
            button.innerHTML = originalContent;
            button.disabled = false;
        } else {
            throw new Error('Report generation failed');
        }
    })
    .catch(error => {
        alert('Error generating report: ' + error.message);
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function showFormatSelection(reportType) {
    const formatHtml = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Report Generated Successfully!</h6>
            <p class="mb-3">Choose your preferred format for download:</p>
            <div class="btn-group" role="group">
                <button class="btn btn-success" onclick="downloadIndividualReport('${reportType}', 'excel')">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
                <button class="btn btn-danger" onclick="downloadIndividualReport('${reportType}', 'pdf')">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </button>
                <button class="btn btn-primary" onclick="downloadIndividualReport('${reportType}', 'word')">
                    <i class="fas fa-file-word me-1"></i>Word
                </button>
            </div>
        </div>
    `;
    
    // Show format selection in results section
    const resultsSection = document.getElementById('resultsSection');
    if (resultsSection) {
        resultsSection.innerHTML = formatHtml;
        resultsSection.style.display = 'block';
    } else {
        // Create a temporary modal or alert
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formatHtml;
        tempDiv.className = 'position-fixed top-50 start-50 translate-middle p-4 bg-white border rounded shadow';
        tempDiv.style.zIndex = '9999';
        document.body.appendChild(tempDiv);
        
        setTimeout(() => {
            document.body.removeChild(tempDiv);
        }, 10000);
    }
}

function downloadIndividualReport(reportType, format) {
    window.location.href = `/api/download-individual-report/${reportType}/${format}`;
}

function previewSampleData(templateType) {
    const sampleData = {
        purchase: {
            title: 'Purchase Template Sample Data',
            headers: ['Date', 'Vendor', 'Invoice No', 'Amount', 'GST', 'Total'],
            rows: [
                ['2024-01-15', 'ABC Suppliers Ltd', 'INV-001', '10000', '1800', '11800'],
                ['2024-01-16', 'XYZ Office Supplies', 'BILL-234', '5000', '900', '5900'],
                ['2024-01-17', 'Tech Solutions Inc', 'TS-456', '25000', '4500', '29500']
            ]
        },
        sales: {
            title: 'Sales Template Sample Data',
            headers: ['Date', 'Customer', 'Invoice No', 'Amount', 'GST', 'Total'],
            rows: [
                ['2024-01-15', 'Client ABC Ltd', 'SALE-001', '50000', '9000', '59000'],
                ['2024-01-16', 'Customer XYZ', 'SALE-002', '25000', '4500', '29500'],
                ['2024-01-17', 'Business DEF', 'SALE-003', '35000', '6300', '41300']
            ]
        },
        income: {
            title: 'Income Template Sample Data',
            headers: ['Date', 'Source', 'Type', 'Amount', 'Tax', 'Net Income'],
            rows: [
                ['2024-01-15', 'Bank Interest', 'Interest Income', '2500', '0', '2500'],
                ['2024-01-16', 'Rental Property', 'Rental Income', '15000', '2700', '12300'],
                ['2024-01-17', 'Investment', 'Dividend Income', '5000', '500', '4500']
            ]
        },
        expense: {
            title: 'Expense Template Sample Data',
            headers: ['Date', 'Category', 'Description', 'Amount', 'Tax', 'Total'],
            rows: [
                ['2024-01-15', 'Office Rent', 'Monthly office rent', '25000', '4500', '29500'],
                ['2024-01-16', 'Utilities', 'Electricity and water', '3500', '630', '4130'],
                ['2024-01-17', 'Marketing', 'Digital advertising', '8000', '1440', '9440']
            ]
        },
        credit_note: {
            title: 'Credit Note Template Sample Data',
            headers: ['Date', 'Customer', 'Original Invoice', 'Reason', 'Amount', 'Total'],
            rows: [
                ['2024-01-15', 'Client ABC', 'SALE-001', 'Product Return', '5000', '5900'],
                ['2024-01-16', 'Customer XYZ', 'SALE-002', 'Discount Adjustment', '2000', '2360'],
                ['2024-01-17', 'Business DEF', 'SALE-003', 'Quality Issue', '3000', '3540']
            ]
        },
        debit_note: {
            title: 'Debit Note Template Sample Data',
            headers: ['Date', 'Vendor', 'Original Bill', 'Reason', 'Amount', 'Total'],
            rows: [
                ['2024-01-15', 'ABC Suppliers', 'INV-001', 'Price Correction', '1000', '1180'],
                ['2024-01-16', 'XYZ Supplies', 'BILL-234', 'Short Delivery', '500', '590'],
                ['2024-01-17', 'Tech Solutions', 'TS-456', 'Defective Items', '2000', '2360']
            ]
        },
        payroll: {
            title: 'Payroll Template Sample Data',
            headers: ['Employee', 'Basic Salary', 'Allowances', 'Deductions', 'Tax', 'Net Pay'],
            rows: [
                ['John Doe', '50000', '10000', '2000', '8000', '50000'],
                ['Jane Smith', '45000', '8000', '1500', '7200', '44300'],
                ['Robert Johnson', '60000', '12000', '3000', '10500', '58500']
            ]
        },
        bank_transfer: {
            title: 'Bank Transfer Template Sample Data',
            headers: ['Date', 'From Account', 'To Account', 'Amount', 'Reference', 'Charges'],
            rows: [
                ['2024-01-15', 'Current Account', 'Savings Account', '100000', 'NEFT123', '25'],
                ['2024-01-16', 'Business Account', 'Current Account', '50000', 'RTGS456', '50'],
                ['2024-01-17', 'Savings Account', 'FD Account', '200000', 'IMPS789', '10']
            ]
        },
        asset_purchase: {
            title: 'Asset Purchase Template Sample Data',
            headers: ['Date', 'Asset Type', 'Vendor', 'Cost', 'Depreciation Method', 'Life'],
            rows: [
                ['2024-01-15', 'Computer Equipment', 'Tech Store', '150000', 'Straight Line', '5 Years'],
                ['2024-01-16', 'Office Furniture', 'Furniture Ltd', '75000', 'Straight Line', '10 Years'],
                ['2024-01-17', 'Vehicle', 'Auto Dealer', '800000', 'Reducing Balance', '8 Years']
            ]
        },
        others: {
            title: 'Others Template Sample Data',
            headers: ['Date', 'Type', 'Description', 'Amount', 'Account', 'Reference'],
            rows: [
                ['2024-01-15', 'Adjustment', 'Year-end adjustment', '5000', 'Misc Income', 'ADJ-001'],
                ['2024-01-16', 'Provision', 'Bad debt provision', '10000', 'Provisions', 'PROV-001'],
                ['2024-01-17', 'Reversal', 'Accrual reversal', '7500', 'Accruals', 'REV-001']
            ]
        }
    };
    
    const data = sampleData[templateType];
    if (!data) {
        alert('Sample data not available for this template type.');
        return;
    }
    
    let tableHtml = `
        <div class="modal fade" id="sampleDataModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${data.title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
    `;
    
    data.headers.forEach(header => {
        tableHtml += `<th>${header}</th>`;
    });
    
    tableHtml += `
                                    </tr>
                                </thead>
                                <tbody>
    `;
    
    data.rows.forEach(row => {
        tableHtml += '<tr>';
        row.forEach(cell => {
            tableHtml += `<td>${cell}</td>`;
        });
        tableHtml += '</tr>';
    });
    
    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            This is sample data showing the expected format. Download the template to get the actual Excel file with proper formatting.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadTemplate('${templateType}')">
                            <i class="fas fa-download me-1"></i>Download Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('sampleDataModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', tableHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sampleDataModal'));
    modal.show();
}

function downloadAllReports(format) {
    window.location.href = `/api/download-all-reports/${format}`;
}

// Upload form handling
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');
    
    // Show progress
    progressSection.style.display = 'block';
    resultsSection.style.display = 'none';
    progressBar.style.width = '10%';
    progressText.textContent = 'Starting upload...';
    
    try {
        progressBar.style.width = '50%';
        progressText.textContent = 'Processing financial data...';
        
        const response = await fetch('/api/automated-accounting/process', {
            method: 'POST',
            body: formData
        });
        
        progressBar.style.width = '100%';
        
        if (response.ok) {
            const result = await response.json();
            progressText.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Processing completed successfully!';
            
            // Show results section
            setTimeout(() => {
                progressSection.style.display = 'none';
                showReports(result);
            }, 1000);
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        progressText.innerHTML = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>Upload failed. Please try again.';
        progressBar.classList.replace('bg-primary', 'bg-danger');
    }
});

function showReports(data) {
    const resultsSection = document.getElementById('resultsSection');
    const reportsGrid = document.getElementById('reportsGrid');
    const resultsSummary = document.getElementById('resultsSummary');
    
    // Update summary
    resultsSummary.innerHTML = `
        <p class="mb-2"><strong>File processed:</strong> ${data.filename || 'Financial data'}</p>
        <p class="mb-0"><strong>Processing time:</strong> ${new Date().toLocaleTimeString()}</p>
    `;
    
    const reports = [
        {name: 'Journal Report', icon: 'fas fa-book', format: 'excel'},
        {name: 'Ledger Report', icon: 'fas fa-list-alt', format: 'excel'},
        {name: 'Trial Balance', icon: 'fas fa-balance-scale', format: 'excel'},
        {name: 'P&L Statement', icon: 'fas fa-chart-line', format: 'excel'},
        {name: 'Balance Sheet', icon: 'fas fa-file-invoice', format: 'excel'},
        {name: 'Cash Flow Statement', icon: 'fas fa-exchange-alt', format: 'excel'}
    ];
    
    reportsGrid.innerHTML = reports.map(report => `
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="${report.icon} fa-2x text-primary mb-3"></i>
                    <h6 class="card-title">${report.name}</h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="downloadReport('${report.name.toLowerCase().replace(/\s+/g, '_')}', '${report.format}')">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsSection.style.display = 'block';
}

function downloadReport(type, format) {
    window.location.href = `/api/download-all-reports/${format}`;
}

// Sample Reports Functions
function generateSampleReport(reportType) {
    console.log(`Generating sample report: ${reportType}`);
    
    // Show preview modal with sample report data
    showSampleReportPreview(reportType);
}

function showSampleReportPreview(reportType) {
    const sampleReports = {
        balance_sheet: {
            title: 'Balance Sheet - Sample Report',
            data: [
                ['ASSETS', ''],
                ['Current Assets:', ''],
                ['Cash and Cash Equivalents', 'â‚¹23,750,000'],
                ['Accounts Receivable', 'â‚¹13,750,000'],
                ['Inventory', 'â‚¹7,425,000'],
                ['Prepaid Expenses', 'â‚¹1,500,000'],
                ['Total Current Assets', 'â‚¹46,425,000'],
                ['', ''],
                ['LIABILITIES', ''],
                ['Current Liabilities:', ''],
                ['Accounts Payable', 'â‚¹8,250,000'],
                ['Accrued Expenses', 'â‚¹3,100,000'],
                ['Short-term Debt', 'â‚¹5,000,000'],
                ['Total Current Liabilities', 'â‚¹16,350,000']
            ]
        },
        income_statement: {
            title: 'Income Statement - Sample Report',
            data: [
                ['REVENUE', ''],
                ['Product Sales', 'â‚¹125,000,000'],
                ['Service Revenue', 'â‚¹45,000,000'],
                ['Other Income', 'â‚¹3,750,000'],
                ['Total Revenue', 'â‚¹173,750,000'],
                ['', ''],
                ['EXPENSES', ''],
                ['Cost of Goods Sold', 'â‚¹87,500,000'],
                ['Salaries and Wages', 'â‚¹25,000,000'],
                ['Rent and Utilities', 'â‚¹12,500,000'],
                ['Marketing Expenses', 'â‚¹8,750,000'],
                ['Total Expenses', 'â‚¹133,750,000'],
                ['', ''],
                ['Net Income', 'â‚¹40,000,000']
            ]
        },
        cash_flow: {
            title: 'Cash Flow Statement - Sample Report',
            data: [
                ['OPERATING ACTIVITIES', ''],
                ['Net Income', 'â‚¹40,000,000'],
                ['Depreciation', 'â‚¹5,000,000'],
                ['Changes in Working Capital', 'â‚¹-2,500,000'],
                ['Net Cash from Operating', 'â‚¹42,500,000'],
                ['', ''],
                ['INVESTING ACTIVITIES', ''],
                ['Purchase of Equipment', 'â‚¹-15,000,000'],
                ['Sale of Investments', 'â‚¹5,000,000'],
                ['Net Cash from Investing', 'â‚¹-10,000,000'],
                ['', ''],
                ['FINANCING ACTIVITIES', ''],
                ['Loan Proceeds', 'â‚¹10,000,000'],
                ['Dividend Payments', 'â‚¹-7,500,000'],
                ['Net Cash from Financing', 'â‚¹2,500,000']
            ]
        }
    };
    
    const reportData = sampleReports[reportType] || {
        title: 'Sample Report',
        data: [['Sample data not available', '']]
    };
    
    let tableHtml = `
        <div class="modal fade" id="sampleReportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${reportData.title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
    `;
    
    reportData.data.forEach(row => {
        const isHeader = row[0] && (row[0].includes('ASSETS') || row[0].includes('LIABILITIES') || 
                                   row[0].includes('REVENUE') || row[0].includes('EXPENSES') || 
                                   row[0].includes('OPERATING') || row[0].includes('INVESTING') || 
                                   row[0].includes('FINANCING'));
        const isTotal = row[0] && row[0].includes('Total');
        const isEmpty = !row[0] || row[0] === '';
        
        if (isEmpty) {
            tableHtml += `<tr><td colspan="2">&nbsp;</td></tr>`;
        } else if (isHeader) {
            tableHtml += `<tr class="table-primary"><td colspan="2"><strong>${row[0]}</strong></td></tr>`;
        } else if (isTotal) {
            tableHtml += `<tr class="table-warning"><td><strong>${row[0]}</strong></td><td class="text-end"><strong>${row[1]}</strong></td></tr>`;
        } else {
            tableHtml += `<tr><td>${row[0]}</td><td class="text-end">${row[1]}</td></tr>`;
        }
    });
    
    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info">
                            <strong>Download Options:</strong> This sample report is available in Excel, PDF, and Word formats.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="downloadFinancialReportPackage()">
                            <i class="fas fa-download me-1"></i>Download Complete Package
                        </button>
                        <button type="button" class="btn btn-primary" onclick="downloadSampleReport('${reportType}', 'excel')">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                        <button type="button" class="btn btn-danger" onclick="downloadSampleReport('${reportType}', 'pdf')">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="downloadSampleReport('${reportType}', 'word')">
                            <i class="fas fa-file-word me-1"></i>Word
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('sampleReportModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', tableHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sampleReportModal'));
    modal.show();
}

function downloadSampleReport(reportType, format) {
    window.location.href = `/download-sample-reports/${format}?type=${reportType}`;
}

function downloadFinancialReportPackage() {
    console.log('Downloading comprehensive financial report package...');
    
    const btn = document.getElementById('downloadPackageBtn');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating Package...';
    btn.disabled = true;
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = '/api/download-financial-report-package';
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Reset button after a delay
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Package Downloaded!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
        }, 3000);
    }, 2000);
}

// Bank Reconciliation Functions
function processBankStatement() {
    const form = document.getElementById('bankStatementForm');
    const formData = new FormData(form);
    
    const statusDiv = document.getElementById('reconciliationStatus');
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Processing...</span></div><p class="mt-2">Processing bank statement...</p>';
    
    fetch('/api/bank-reconciliation/process', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayReconciliationResults(data);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error processing bank statement'}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}

function displayReconciliationResults(data) {
    const statusDiv = document.getElementById('reconciliationStatus');
    const resultsDiv = document.getElementById('reconciliationResults');
    const tableDiv = document.getElementById('reconciliationTable');
    const tableBody = document.getElementById('reconciliationTableBody');
    
    statusDiv.style.display = 'none';
    resultsDiv.style.display = 'block';
    tableDiv.style.display = 'block';
    
    // Update statistics
    document.getElementById('matchedCount').textContent = data.stats.matched || 0;
    document.getElementById('partialCount').textContent = data.stats.partial || 0;
    document.getElementById('unmatchedCount').textContent = data.stats.unmatched || 0;
    
    // Populate transactions table
    tableBody.innerHTML = data.transactions.map(tx => `
        <tr>
            <td>${tx.date}</td>
            <td>${tx.description}</td>
            <td class="${tx.amount >= 0 ? 'amount-credit' : 'amount-debit'}">â‚¹${Math.abs(tx.amount).toFixed(2)}</td>
            <td><span class="status-badge status-${tx.status}">${tx.status}</span></td>
            <td>${tx.matched_to || '-'}</td>
            <td>
                <div class="confidence-score" style="--confidence: ${tx.confidence * 100}%"></div>
                ${(tx.confidence * 100).toFixed(0)}%
            </td>
            <td>
                ${tx.status === 'unmatched' ? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="openMappingModal('${tx.id}')">Map</button>` : 
                    `<button class="btn btn-sm btn-outline-success" disabled>Matched</button>`
                }
            </td>
        </tr>
    `).join('');
}

// Enhanced Manual Journal Entry Functions with Workflow Management
let chartOfAccounts = [];
let currentJournalEntries = [];
let selectedJournalId = null;
let postedEntriesRefreshInterval;

// Load chart of accounts when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadChartOfAccounts();
    initializeJournalForm();
    loadJournalEntriesList();
    startPostedEntriesAutoRefresh();
});

function loadChartOfAccounts() {
    fetch('/api/chart-of-accounts')
    .then(response => response.json())
    .then(data => {
        // Backend returns array of objects with account_code, account_name, account_type
        chartOfAccounts = data.map(account => ({
            code: account.account_code,
            name: account.account_name,
            type: account.account_type
        }));
        populateAccountDropdowns();
    })
    .catch(error => {
        console.error('Error loading chart of accounts:', error);
        // Fallback to standard chart of accounts
        chartOfAccounts = getStandardChartOfAccounts();
        populateAccountDropdowns();
    });
}

function getStandardChartOfAccounts() {
    return [
        // Assets
        {code: '1000', name: 'Cash and Cash Equivalents', type: 'assets'},
        {code: '1020', name: 'Bank Account - Current', type: 'assets'},
        {code: '1100', name: 'Accounts Receivable', type: 'assets'},
        {code: '1200', name: 'Inventory', type: 'assets'},
        {code: '1400', name: 'Fixed Assets', type: 'assets'},
        // Liabilities
        {code: '2000', name: 'Current Liabilities', type: 'liabilities'},
        {code: '2010', name: 'Accounts Payable', type: 'liabilities'},
        {code: '2200', name: 'Tax Liabilities', type: 'liabilities'},
        // Equity
        {code: '3000', name: 'Owner\'s Equity', type: 'equity'},
        {code: '3010', name: 'Share Capital', type: 'equity'},
        // Revenue
        {code: '4000', name: 'Sales Revenue', type: 'revenue'},
        {code: '4100', name: 'Other Income', type: 'revenue'},
        // Expenses
        {code: '5000', name: 'Cost of Goods Sold', type: 'expenses'},
        {code: '5100', name: 'Operating Expenses', type: 'expenses'},
        {code: '5110', name: 'Salaries and Wages', type: 'expenses'},
        {code: '5120', name: 'Rent Expense', type: 'expenses'},
        {code: '5200', name: 'Financial Expenses', type: 'expenses'}
    ];
}

function populateAccountDropdowns() {
    const selects = document.querySelectorAll('.account-select');
    
    // Group accounts by type for better organization
    const groupedAccounts = chartOfAccounts.reduce((groups, account) => {
        const type = account.type || 'other';
        if (!groups[type]) groups[type] = [];
        groups[type].push(account);
        return groups;
    }, {});
    
    let options = '<option value="">Select Account...</option>';
    
    // Add accounts in organized groups
    Object.keys(groupedAccounts).forEach(type => {
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
        options += `<optgroup label="${typeLabel}">`;
        groupedAccounts[type].forEach(account => {
            options += `<option value="${account.code}">${account.code} - ${account.name}</option>`;
        });
        options += '</optgroup>';
    });
    
    selects.forEach(select => {
        select.innerHTML = options;
    });
}

function initializeJournalForm() {
    // Set default date to today
    document.getElementById('journalDate').valueAsDate = new Date();
    
    // Add event listeners
    document.getElementById('addJournalEntry').addEventListener('click', addJournalEntry);
    document.getElementById('validateJournal').addEventListener('click', validateJournalEntry);
    
    // Add event listeners for real-time calculation
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('debit-amount') || e.target.classList.contains('credit-amount')) {
            updateJournalTotals();
            updateAccountingEffects();
        }
    });
    
    // Add event listeners for account selection
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('account-select')) {
            updateAccountingEffect(e.target);
        }
    });
    
    // Remove entry functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-entry') || e.target.closest('.remove-entry')) {
            removeJournalEntry(e.target);
        }
    });
}

function addJournalEntry() {
    const container = document.getElementById('journalEntries');
    const entryCount = container.children.length + 1;
    
    const newEntry = document.createElement('div');
    newEntry.className = 'journal-entry-row row g-2 mb-2';
    newEntry.setAttribute('data-entry', entryCount);
    
    const accountOptions = chartOfAccounts.reduce((groups, account) => {
        const type = account.type || 'other';
        if (!groups[type]) groups[type] = [];
        groups[type].push(account);
        return groups;
    }, {});
    
    let selectOptions = '<option value="">Select Account...</option>';
    Object.keys(accountOptions).forEach(type => {
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
        selectOptions += `<optgroup label="${typeLabel}">`;
        accountOptions[type].forEach(account => {
            selectOptions += `<option value="${account.code}">${account.code} - ${account.name}</option>`;
        });
        selectOptions += '</optgroup>';
    });
    
    newEntry.innerHTML = `
        <div class="col-md-3">
            <select class="form-select account-select" name="account_code[]" required>
                ${selectOptions}
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="description[]" placeholder="Description" required>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control debit-amount" name="debit_amount[]" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control credit-amount" name="credit_amount[]" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="col-md-1">
            <small class="accounting-effect text-muted">-</small>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm remove-entry">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(newEntry);
    updateJournalTotals();
    updateEntryCount();
}

function removeJournalEntry(button) {
    const entryRow = button.closest('.journal-entry-row');
    const container = document.getElementById('journalEntries');
    
    // Don't allow removing if it's the only entry
    if (container.children.length > 1) {
        entryRow.remove();
        updateJournalTotals();
        updateEntryCount();
    }
}

function updateJournalTotals() {
    const debitInputs = document.querySelectorAll('.debit-amount');
    const creditInputs = document.querySelectorAll('.credit-amount');
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    debitInputs.forEach(input => {
        totalDebits += parseFloat(input.value) || 0;
    });
    
    creditInputs.forEach(input => {
        totalCredits += parseFloat(input.value) || 0;
    });
    
    const difference = totalDebits - totalCredits;
    
    // Update display
    document.getElementById('totalDebits').textContent = `â‚¹${totalDebits.toFixed(2)}`;
    document.getElementById('totalCredits').textContent = `â‚¹${totalCredits.toFixed(2)}`;
    
    const differenceElement = document.getElementById('entryBalance');
    differenceElement.textContent = `â‚¹${Math.abs(difference).toFixed(2)}`;
    
    // Update validation status
    updateValidationStatus(totalDebits, totalCredits, difference);
}

function updateValidationStatus(totalDebits, totalCredits, difference) {
    const statusDiv = document.getElementById('validationStatus');
    const entryCount = document.getElementById('journalEntries').children.length;
    
    if (entryCount < 2) {
        statusDiv.innerHTML = `
            <div class="alert alert-info py-2" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <small>Add at least 2 entries to validate</small>
            </div>
        `;
        return;
    }
    
    if (Math.abs(difference) < 0.01) {
        statusDiv.innerHTML = `
            <div class="alert alert-success py-2" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <small>Double-entry balanced! Ready to save.</small>
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="alert alert-warning py-2" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>Entry not balanced. Difference: â‚¹${Math.abs(difference).toFixed(2)}</small>
            </div>
        `;
    }
}

function updateEntryCount() {
    const entryCount = document.getElementById('journalEntries').children.length;
    document.getElementById('entryCount').textContent = entryCount;
}

function updateAccountingEffect(selectElement) {
    const accountCode = selectElement.value;
    const entryRow = selectElement.closest('.journal-entry-row');
    const effectElement = entryRow.querySelector('.accounting-effect');
    
    if (!accountCode) {
        effectElement.textContent = '-';
        return;
    }
    
    const account = chartOfAccounts.find(acc => acc.code === accountCode);
    if (!account) {
        effectElement.textContent = '-';
        return;
    }
    
    // Determine the normal balance for the account type
    const accountType = account.type.toLowerCase();
    let normalBalance = '';
    
    switch (accountType) {
        case 'assets':
        case 'expenses':
            normalBalance = 'â†‘ Dr / â†“ Cr';
            effectElement.className = 'accounting-effect text-primary';
            break;
        case 'liabilities':
        case 'equity':
        case 'revenue':
            normalBalance = 'â†“ Dr / â†‘ Cr';
            effectElement.className = 'accounting-effect text-success';
            break;
        default:
            normalBalance = '-';
            effectElement.className = 'accounting-effect text-muted';
    }
    
    effectElement.textContent = normalBalance;
}

function updateAccountingEffects() {
    const selectElements = document.querySelectorAll('.account-select');
    selectElements.forEach(select => {
        if (select.value) {
            updateAccountingEffect(select);
        }
    });
}

function validateJournalEntry() {
    const form = document.getElementById('manualJournalForm');
    const formData = new FormData(form);
    
    // Collect journal entries
    const entries = [];
    const accounts = formData.getAll('account_code[]');
    const descriptions = formData.getAll('description[]');
    const debits = formData.getAll('debit_amount[]');
    const credits = formData.getAll('credit_amount[]');
    
    for (let i = 0; i < accounts.length; i++) {
        if (accounts[i] && (debits[i] || credits[i])) {
            entries.push({
                account_code: accounts[i],
                description: descriptions[i],
                debit_amount: parseFloat(debits[i]) || 0,
                credit_amount: parseFloat(credits[i]) || 0
            });
        }
    }
    
    const journalData = {
        date: document.getElementById('journalDate').value,
        reference: document.getElementById('journalReference').value,
        description: document.getElementById('journalDescription').value,
        type: document.getElementById('journalType').value,
        entries: entries
    };
    
    fetch('/api/manual-journal/validate-entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(journalData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.is_valid) {
            showValidationResults(data);
        } else {
            showValidationError(data);
        }
    })
    .catch(error => {
        showValidationError('Error validating journal entry: ' + error.message);
    });
}

function showValidationResults(data) {
    const rulesStatusDiv = document.getElementById('accountingRulesStatus');
    
    if (data.is_valid) {
        let html = '<div class="card border-success mt-3">';
        html += '<div class="card-header bg-success text-white"><h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Validation Passed</h6></div>';
        html += '<div class="card-body">';
        
        // Double Entry Validation
        const doubleEntry = data.validation_details.double_entry;
        html += `<div class="row mb-3">
            <div class="col-md-6">
                <strong>Total Debits:</strong> â‚¹${doubleEntry.total_debits.toFixed(2)}
            </div>
            <div class="col-md-6">
                <strong>Total Credits:</strong> â‚¹${doubleEntry.total_credits.toFixed(2)}
            </div>
        </div>`;
        
        // Transaction Pattern
        if (data.validation_details.transaction_pattern) {
            const pattern = data.validation_details.transaction_pattern;
            html += `<div class="alert alert-info mb-3">
                <strong>Transaction Pattern:</strong> ${pattern.description}
            </div>`;
        }
        
        // Warnings (if any)
        if (data.warnings && data.warnings.length > 0) {
            html += '<div class="alert alert-warning"><strong>Warnings:</strong><ul class="mb-0">';
            data.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul></div>';
        }
        
        // Compliance Score
        if (data.validation_details.accounting_compliance) {
            const compliance = data.validation_details.accounting_compliance;
            html += `<div class="mb-3">
                <strong>Compliance Score:</strong> 
                <span class="badge bg-success">${compliance.compliance_score}%</span>
            </div>`;
        }
        
        // Review and Submit Options
        html += '<div class="mt-4 border-top pt-3">';
        html += '<h6>Review & Submission Options:</h6>';
        html += '<div class="btn-group me-3" role="group">';
        html += '<button type="button" class="btn btn-outline-info" onclick="showDetailedValidation()" data-bs-toggle="modal" data-bs-target="#validationModal">';
        html += '<i class="fas fa-eye me-1"></i>Detailed Review</button>';
        html += '<button type="button" class="btn btn-success" onclick="submitJournalEntryWithReview()">';
        html += '<i class="fas fa-paper-plane me-1"></i>Submit for Review</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div></div>';
        rulesStatusDiv.innerHTML = html;
        
        // Store validation data for later use
        window.currentValidationData = data;
    } else {
        showValidationError(data);
    }
}

function showValidationError(data) {
    const rulesStatusDiv = document.getElementById('accountingRulesStatus');
    
    let html = '<div class="card border-danger mt-3">';
    html += '<div class="card-header bg-danger text-white"><h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Validation Failed</h6></div>';
    html += '<div class="card-body">';
    
    if (data.errors && data.errors.length > 0) {
        html += '<div class="alert alert-danger"><strong>Errors:</strong><ul class="mb-0">';
        data.errors.forEach(error => {
            html += `<li>${error}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (data.warnings && data.warnings.length > 0) {
        html += '<div class="alert alert-warning"><strong>Warnings:</strong><ul class="mb-0">';
        data.warnings.forEach(warning => {
            html += `<li>${warning}</li>`;
        });
        html += '</ul></div>';
    }
    
    html += '<div class="mt-3">';
    html += '<button type="button" class="btn btn-outline-warning" onclick="clearValidation()">';
    html += '<i class="fas fa-undo me-1"></i>Clear & Retry</button>';
    html += '</div>';
    
    html += '</div></div>';
    rulesStatusDiv.innerHTML = html;
}

function showDetailedValidation() {
    if (!window.currentValidationData) return;
    
    const data = window.currentValidationData;
    const modalBody = document.querySelector('#validationModal .modal-body');
    
    let html = '<div class="accordion" id="validationAccordion">';
    
    // Double Entry Validation Details
    html += `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#doubleEntryDetails">
                    <i class="fas fa-balance-scale me-2"></i>Double Entry Validation
                </button>
            </h2>
            <div id="doubleEntryDetails" class="accordion-collapse collapse show" data-bs-parent="#validationAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Total Debits:</strong> â‚¹${data.validation_details.double_entry.total_debits.toFixed(2)}
                        </div>
                        <div class="col-md-6">
                            <strong>Total Credits:</strong> â‚¹${data.validation_details.double_entry.total_credits.toFixed(2)}
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>Status:</strong> <span class="badge bg-success">Balanced</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Transaction Pattern Details
    if (data.validation_details.transaction_pattern) {
        const pattern = data.validation_details.transaction_pattern;
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#patternDetails">
                        <i class="fas fa-chart-line me-2"></i>Transaction Pattern Analysis
                    </button>
                </h2>
                <div id="patternDetails" class="accordion-collapse collapse" data-bs-parent="#validationAccordion">
                    <div class="accordion-body">
                        <p><strong>Pattern:</strong> ${pattern.description}</p>
                        <p><strong>Confidence:</strong> ${pattern.confidence || 'High'}</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Accounting Rules Details
    if (data.validation_details.accounting_compliance) {
        const compliance = data.validation_details.accounting_compliance;
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#complianceDetails">
                        <i class="fas fa-gavel me-2"></i>Accounting Rules Compliance
                    </button>
                </h2>
                <div id="complianceDetails" class="accordion-collapse collapse" data-bs-parent="#validationAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <strong>Compliance Score:</strong> 
                            <span class="badge bg-success">${compliance.compliance_score}%</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Passed Rules:</h6>
                                <ul class="text-success">
                                    ${compliance.passed_rules ? compliance.passed_rules.map(rule => `<li>${rule}</li>`).join('') : '<li>All basic rules passed</li>'}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Notes:</h6>
                                <p class="text-muted">${compliance.notes || 'Transaction follows standard accounting principles'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    modalBody.innerHTML = html;
}

function submitJournalEntryWithReview() {
    if (!window.currentValidationData) {
        alert('Please validate the journal entry first');
        return;
    }
    
    const form = document.getElementById('manualJournalForm');
    const formData = new FormData(form);
    
    // Collect journal entries
    const entries = [];
    const accounts = formData.getAll('account_code[]');
    const descriptions = formData.getAll('description[]');
    const debits = formData.getAll('debit_amount[]');
    const credits = formData.getAll('credit_amount[]');
    
    for (let i = 0; i < accounts.length; i++) {
        if (accounts[i] && (debits[i] || credits[i])) {
            entries.push({
                account_code: accounts[i],
                description: descriptions[i],
                debit_amount: parseFloat(debits[i]) || 0,
                credit_amount: parseFloat(credits[i]) || 0
            });
        }
    }
    
    const journalData = {
        date: document.getElementById('journalDate').value,
        reference: document.getElementById('journalReference').value,
        description: document.getElementById('journalDescription').value,
        type: document.getElementById('journalType').value,
        entries: entries
    };
    
    // Show loading state
    const submitBtn = document.querySelector('button[onclick="submitJournalEntryWithReview()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
    submitBtn.disabled = true;
    
    fetch('/api/manual-journal/create-with-review', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(journalData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSubmissionSuccess(data);
        } else {
            showSubmissionError(data.error);
        }
    })
    .catch(error => {
        showSubmissionError('Error submitting journal entry: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function showSubmissionSuccess(data) {
    const rulesStatusDiv = document.getElementById('accountingRulesStatus');
    
    let html = '<div class="card border-success mt-3">';
    html += '<div class="card-header bg-success text-white"><h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Journal Entry Submitted</h6></div>';
    html += '<div class="card-body">';
    html += `<div class="alert alert-success">
        <strong>Entry ID:</strong> ${data.entry_id}<br>
        <strong>Status:</strong> ${data.status}<br>
        <strong>Next Step:</strong> ${data.next_step || 'Awaiting review and approval'}
    </div>`;
    
    if (data.review_url) {
        html += `<div class="mt-3">
            <a href="${data.review_url}" class="btn btn-outline-primary">
                <i class="fas fa-eye me-1"></i>View Entry Details
            </a>
        </div>`;
    }
    
    html += '</div></div>';
    rulesStatusDiv.innerHTML = html;
    
    // Clear the form
    document.getElementById('manualJournalForm').reset();
    document.getElementById('journalEntries').innerHTML = '';
    addJournalEntry(); // Add one default entry
    updateJournalTotals();
}

function showSubmissionError(error) {
    const rulesStatusDiv = document.getElementById('accountingRulesStatus');
    
    let html = '<div class="card border-danger mt-3">';
    html += '<div class="card-header bg-danger text-white"><h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Submission Failed</h6></div>';
    html += '<div class="card-body">';
    html += `<div class="alert alert-danger">${error}</div>`;
    html += '<div class="mt-3">';
    html += '<button type="button" class="btn btn-outline-warning" onclick="clearValidation()">';
    html += '<i class="fas fa-undo me-1"></i>Try Again</button>';
    html += '</div>';
    html += '</div></div>';
    rulesStatusDiv.innerHTML = html;
}

function clearValidation() {
    const rulesStatusDiv = document.getElementById('accountingRulesStatus');
    rulesStatusDiv.innerHTML = '';
    window.currentValidationData = null;
}

// Bank Reconciliation Functions
function submitBankStatement() {
    const form = document.getElementById('bankStatementForm');
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Show processing status
    document.getElementById('reconciliationStatus').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-2 text-muted">Processing bank statement...</p>
        </div>
    `;
    
    fetch('/api/bank-reconciliation/process', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayReconciliationResults(data.results);
            showReconciliationStats(data.statistics);
            showAdvancedFeatures();
            if (data.transactions) {
                populateTransactionTable(data.transactions);
            }
        } else {
            showBankReconciliationError(data.error);
        }
    })
    .catch(error => {
        showBankReconciliationError('Error processing bank statement: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayReconciliationResults(results) {
    const tableBody = document.getElementById('reconciliationTableBody');
    const table = document.getElementById('reconciliationTable');
    const resultsDiv = document.getElementById('reconciliationResults');
    const manualSection = document.getElementById('manualMappingSection');
    
    // Clear existing results
    tableBody.innerHTML = '';
    
    // Show results table
    table.style.display = 'block';
    resultsDiv.style.display = 'block';
    
    let unmatchedTransactions = [];
    let doubtfulTransactions = [];
    let mappedTransactions = [];
    
    results.forEach(transaction => {
        const row = document.createElement('tr');
        
        // Enhanced color-coded status system
        let statusClass = 'bg-secondary';
        let statusText = transaction.status;
        let rowClass = '';
        
        // Determine confidence level and color coding
        const confidenceScore = transaction.confidence || 0;
        
        if (transaction.status === 'matched' || confidenceScore >= 80) {
            statusClass = 'bg-success';
            statusText = 'Mapped';
            rowClass = 'table-success';
            mappedTransactions.push(transaction);
        } else if (transaction.status === 'partial' || (confidenceScore >= 50 && confidenceScore < 80)) {
            statusClass = 'bg-warning';
            statusText = 'Doubtful';
            rowClass = 'table-warning';
            doubtfulTransactions.push(transaction);
        } else {
            statusClass = 'bg-danger';
            statusText = 'Unmapped';
            rowClass = 'table-danger';
            unmatchedTransactions.push(transaction);
        }
        
        // Apply row styling based on status
        row.className = rowClass;
        
        // Confidence score styling with enhanced visualization
        const confidenceColor = confidenceScore >= 80 ? 'success' : confidenceScore >= 50 ? 'warning' : 'danger';
        const confidenceIcon = confidenceScore >= 80 ? 'fas fa-check-circle' : confidenceScore >= 50 ? 'fas fa-exclamation-triangle' : 'fas fa-times-circle';
        
        row.innerHTML = `
            <td>${formatDate(transaction.date)}</td>
            <td>${transaction.description}</td>
            <td class="${transaction.amount > 0 ? 'amount-credit' : 'amount-debit'}">
                â‚¹${Math.abs(transaction.amount).toFixed(2)}
            </td>
            <td>
                <span class="badge ${transaction.type === 'credit' ? 'bg-success' : 'bg-danger'}">
                    ${transaction.type.toUpperCase()}
                </span>
            </td>
            <td>
                <span class="badge ${statusClass}">
                    <i class="${confidenceIcon} me-1"></i>${statusText}
                </span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress" style="width: 60px; height: 10px;">
                        <div class="progress-bar bg-${confidenceColor}" 
                             style="width: ${confidenceScore}%"></div>
                    </div>
                    <small class="ms-2 fw-bold text-${confidenceColor}">${confidenceScore}%</small>
                </div>
            </td>
            <td>
                ${transaction.match_details ? 
                    `<small class="text-muted">${transaction.match_details}</small>` : 
                    '<span class="text-muted">-</span>'
                }
            </td>
            <td>
                ${transaction.status === 'unmatched' || confidenceScore < 50 ? 
                    `<button class="btn btn-danger btn-sm" 
                             onclick="openManualMapping('${transaction.transaction_id}')">
                        <i class="fas fa-edit me-1"></i>Manual Map
                    </button>` :
                    transaction.status === 'matched' || confidenceScore >= 80 ?
                    `<button class="btn btn-success btn-sm" disabled>
                        <i class="fas fa-check me-1"></i>Mapped
                    </button>` :
                    `<button class="btn btn-warning btn-sm" 
                             onclick="reviewTransaction('${transaction.transaction_id}')">
                        <i class="fas fa-eye me-1"></i>Review
                    </button>`
                }
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Enhanced manual mapping display with color-coded sections
    displayColorCodedTransactions(mappedTransactions, doubtfulTransactions, unmatchedTransactions);
    
    // Show manual mapping section if there are unmapped or doubtful transactions
    if (unmatchedTransactions.length > 0 || doubtfulTransactions.length > 0) {
        manualSection.style.display = 'block';
    }
}

function showReconciliationStats(stats) {
    document.getElementById('matchedCount').textContent = stats.matched || 0;
    document.getElementById('partialCount').textContent = stats.partial || 0;
    document.getElementById('unmatchedCount').textContent = stats.unmatched || 0;
}

// Enhanced Color-Coded Transaction Display
function displayColorCodedTransactions(mappedTransactions, doubtfulTransactions, unmatchedTransactions) {
    const container = document.getElementById('unmatchedTransactions');
    
    let html = '<div class="row g-4">';
    
    // GREEN - Mapped Transactions Section
    if (mappedTransactions.length > 0) {
        html += `
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Mapped Transactions (${mappedTransactions.length})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
        `;
        
        mappedTransactions.forEach(transaction => {
            html += `
                <div class="col-md-6">
                    <div class="card bg-success bg-opacity-10 border-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-success">âœ“ Successfully Mapped</h6>
                                    <p class="mb-2"><strong>Date:</strong> ${formatDate(transaction.date)}</p>
                                    <p class="mb-2"><strong>Amount:</strong> â‚¹${Math.abs(transaction.amount).toFixed(2)}</p>
                                    <p class="mb-0 small text-muted">${transaction.description}</p>
                                </div>
                                <span class="badge bg-success">${transaction.confidence}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // YELLOW - Doubtful Transactions Section
    if (doubtfulTransactions.length > 0) {
        html += `
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Doubtful Transactions - Manual Review Required (${doubtfulTransactions.length})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
        `;
        
        doubtfulTransactions.forEach(transaction => {
            html += createDoubtfulTransactionCard(transaction);
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // RED - Unmapped Transactions Section
    if (unmatchedTransactions.length > 0) {
        html += `
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-times-circle me-2"></i>
                            Unmapped Transactions - Manual Mapping Required (${unmatchedTransactions.length})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
        `;
        
        unmatchedTransactions.forEach(transaction => {
            html += createUnmappedTransactionCard(transaction);
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function createDoubtfulTransactionCard(transaction) {
    return `
        <div class="col-md-6">
            <div class="card border-warning bg-warning bg-opacity-10">
                <div class="card-header bg-warning bg-opacity-25">
                    <h6 class="mb-0 text-warning">
                        <i class="fas fa-question-circle me-2"></i>
                        Needs Review (${transaction.confidence}% confidence)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Date:</strong> ${formatDate(transaction.date)}
                        </div>
                        <div class="col-6">
                            <strong>Amount:</strong> 
                            <span class="${transaction.amount > 0 ? 'text-success' : 'text-danger'}">
                                â‚¹${Math.abs(transaction.amount).toFixed(2)}
                            </span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Description:</strong><br>
                        <small class="text-muted">${transaction.description}</small>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-warning btn-sm flex-fill" 
                                onclick="reviewTransaction('${transaction.transaction_id}')">
                            <i class="fas fa-eye me-1"></i>Review Match
                        </button>
                        <button class="btn btn-warning btn-sm flex-fill" 
                                onclick="openManualMapping('${transaction.transaction_id}')">
                            <i class="fas fa-edit me-1"></i>Manual Map
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createUnmappedTransactionCard(transaction) {
    return `
        <div class="col-md-6">
            <div class="card border-danger bg-danger bg-opacity-10">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-times-circle me-2"></i>
                        Unmapped Transaction
                    </h6>
                </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Date:</strong> ${formatDate(transaction.date)}
                            </div>
                            <div class="col-6">
                                <strong>Amount:</strong> 
                                <span class="${transaction.amount > 0 ? 'text-success' : 'text-danger'}">
                                    â‚¹${Math.abs(transaction.amount).toFixed(2)}
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Description:</strong><br>
                            <small class="text-muted">${transaction.description}</small>
                        </div>
                        
                        <!-- Advanced Invoice Search -->
                        <div class="invoice-search mb-3">
                            <label class="form-label fw-bold">Search Available Invoices</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search by invoice number, party name, amount..."
                                       onkeyup="searchInvoicesAdvanced('${transaction.transaction_id}', this.value)">
                                <button class="btn btn-outline-secondary" type="button" onclick="showAllInvoicesAdvanced('${transaction.transaction_id}')">
                                    <i class="fas fa-list"></i> Show All
                                </button>
                            </div>
                            <div id="invoiceResults_${transaction.transaction_id}" class="mt-2"></div>
                        </div>
                        
                        <!-- Professional Confidence Analysis -->
                        <div class="confidence-analysis mb-3" id="confidenceAnalysis_${transaction.transaction_id}" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-header py-2">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-chart-bar me-2"></i>Mapping Confidence Analysis
                                    </h6>
                                </div>
                                <div class="card-body py-2">
                                    <div class="confidence-factors">
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <small class="text-muted">Amount Match:</small>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="amountScore_${transaction.transaction_id}"></div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Date Proximity:</small>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="dateScore_${transaction.transaction_id}"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2 mt-1">
                                            <div class="col-6">
                                                <small class="text-muted">Reference Match:</small>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="referenceScore_${transaction.transaction_id}"></div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Party Match:</small>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="partyScore_${transaction.transaction_id}"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Overall Confidence:</small>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 12px;">
                                                    <div class="progress-bar" role="progressbar" style="width: 0%" id="overallScore_${transaction.transaction_id}"></div>
                                                </div>
                                                <span class="badge" id="confidenceBadge_${transaction.transaction_id}">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Account Mapping -->
                        <form id="mappingForm_${transaction.transaction_id}" onsubmit="submitAdvancedMapping(event, '${transaction.transaction_id}')">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Manual Account Mapping</label>
                                <select class="form-select" name="account_code">
                                    <option value="">Choose account...</option>
                                    <optgroup label="Assets">
                                        <option value="1000">1000 - Cash Account</option>
                                        <option value="1100">1100 - Bank Account</option>
                                        <option value="1200">1200 - Accounts Receivable</option>
                                        <option value="1300">1300 - Inventory</option>
                                        <option value="1500">1500 - Fixed Assets</option>
                                    </optgroup>
                                    <optgroup label="Liabilities">
                                        <option value="2000">2000 - Accounts Payable</option>
                                        <option value="2100">2100 - Accrued Expenses</option>
                                        <option value="2200">2200 - Long-term Debt</option>
                                        <option value="2300">2300 - Tax Payable</option>
                                    </optgroup>
                                    <optgroup label="Expenses">
                                        <option value="5000">5000 - General Expenses</option>
                                        <option value="5100">5100 - Rent Expense</option>
                                        <option value="5200">5200 - Utilities</option>
                                        <option value="5300">5300 - Salary Expense</option>
                                        <option value="5400">5400 - Marketing Expenses</option>
                                        <option value="5500">5500 - Interest Expense</option>
                                    </optgroup>
                                    <optgroup label="Revenue">
                                        <option value="4000">4000 - Sales Revenue</option>
                                        <option value="4100">4100 - Service Revenue</option>
                                        <option value="4200">4200 - Other Income</option>
                                    </optgroup>
                                    <optgroup label="Equity">
                                        <option value="3000">3000 - Capital</option>
                                        <option value="3200">3200 - Dividends</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <input type="hidden" name="selected_invoice_id" id="selectedInvoice_${transaction.transaction_id}">
                            <input type="hidden" name="confidence_score" id="selectedConfidence_${transaction.transaction_id}">
                            
                            <div class="mb-3">
                                <label class="form-label">Transaction Notes & Justification</label>
                                <textarea class="form-control" name="notes" rows="2" 
                                         placeholder="Add mapping notes and business justification..."></textarea>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-link me-1"></i>Create Professional Mapping & Journal Entry
                                </button>
                                <button type="button" class="btn btn-outline-warning" 
                                        onclick="flagForReview('${transaction.transaction_id}')">
                                    <i class="fas fa-flag me-1"></i>Flag for Management Review
                                </button>
                                <button type="button" class="btn btn-outline-secondary" 
                                        onclick="ignoreTransaction('${transaction.transaction_id}')">
                                    <i class="fas fa-eye-slash me-1"></i>Mark as Ignored
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function submitManualMapping(event, transactionId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Mapping...';
    submitBtn.disabled = true;
    
    const mappingData = {
        transaction_id: transactionId,
        account_code: formData.get('account_code'),
        notes: formData.get('notes')
    };
    
    fetch('/api/bank-reconciliation/map-transaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMappingSuccess(transactionId);
            // Refresh reconciliation results
            refreshReconciliation();
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error mapping transaction: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function processMatchedTransactions() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    button.disabled = true;
    
    fetch('/api/bank-reconciliation/process-matched', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showProcessingSuccess(data);
        } else {
            showProcessingError(data.error);
        }
    })
    .catch(error => {
        showProcessingError('Error processing matched transactions: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshReconciliation() {
    // Refresh the reconciliation data
    const accountCode = document.getElementById('bankAccountCode').value;
    if (!accountCode) {
        alert('Please enter bank account code first');
        return;
    }
    
    fetch(`/api/bank-reconciliation/dashboard?account_code=${accountCode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayReconciliationResults(data.results);
            showReconciliationStats(data.statistics);
        }
    })
    .catch(error => {
        console.error('Error refreshing reconciliation:', error);
    });
}

// Load demo data for bank reconciliation testing
function loadDemoReconciliationData() {
    fetch('/api/bank-reconciliation/demo-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Demo data loaded successfully:', data.data);
                populateReconciliationDashboard(data.data);
            } else {
                console.error('Failed to load demo data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading demo data:', error);
        });
}

// Populate the reconciliation dashboard with demo data
function populateReconciliationDashboard(demoData) {
    // Initialize and populate pie chart
    initializeReconciliationChart(demoData.statistics);
    
    // Populate transactions table
    populateTransactionsTable(demoData.transactions);
    
    // Update quick action panel
    updateQuickActionPanel(demoData.statistics);
    
    // Display exceptions
    displayExceptions(demoData.exceptions);
    
    // Update activity log
    updateActivityLog(demoData.activity_log);
    
    // Update batch controls
    updateBatchControls(demoData.statistics);
    
    // Update summary counters
    updateSummaryCounters(demoData.statistics);
}

// Initialize reconciliation status pie chart
function initializeReconciliationChart(statistics) {
    const ctx = document.getElementById('reconciliationChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (window.reconciliationChart) {
        window.reconciliationChart.destroy();
    }
    
    window.reconciliationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['AI Matches', 'Manual Matches', 'Unmatched', 'Exceptions'],
            datasets: [{
                data: [statistics.ai_matches, statistics.manual_matches, statistics.unmatched, statistics.exceptions],
                backgroundColor: [
                    '#28a745', // Green for AI matches
                    '#007bff', // Blue for manual matches  
                    '#ffc107', // Yellow for unmatched
                    '#dc3545'  // Red for exceptions
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Populate transactions table with demo data
function populateTransactionsTable(transactions) {
    const tbody = document.querySelector('#transactionsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    transactions.forEach(transaction => {
        const statusClass = getStatusClass(transaction.status);
        const statusBadge = getStatusBadge(transaction.status);
        const amountClass = transaction.amount > 0 ? 'text-success' : 'text-danger';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input" data-transaction-id="${transaction.id}">
            </td>
            <td>
                <div class="fw-bold">${transaction.id}</div>
                <div class="small text-muted">${transaction.date}</div>
            </td>
            <td>
                <div class="transaction-desc">${transaction.description}</div>
                <div class="small text-muted">${transaction.reference}</div>
            </td>
            <td class="${amountClass} fw-bold">â‚¹${Math.abs(transaction.amount).toLocaleString()}</td>
            <td>
                <div class="d-flex align-items-center">
                    ${statusBadge}
                    <div class="ms-2">
                        <div class="progress" style="width: 60px; height: 8px;">
                            <div class="progress-bar ${statusClass}" style="width: ${transaction.confidence}%"></div>
                        </div>
                        <div class="small text-muted">${transaction.confidence}%</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="btn-group">
                    ${getActionButtons(transaction)}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Get status class for styling
function getStatusClass(status) {
    switch(status) {
        case 'matched': return 'bg-success';
        case 'unmatched': return 'bg-warning';
        case 'doubtful': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Get status badge
function getStatusBadge(status) {
    const statusClass = getStatusClass(status);
    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
    return `<span class="badge ${statusClass}">${statusText}</span>`;
}

// Get action buttons based on transaction status
function getActionButtons(transaction) {
    if (transaction.status === 'matched') {
        return `
            <button class="btn btn-outline-primary btn-sm" onclick="viewMapping('${transaction.id}')">
                <i class="fas fa-eye"></i> View
            </button>
        `;
    } else if (transaction.status === 'unmatched') {
        return `
            <button class="btn btn-outline-warning btn-sm" onclick="manualMap('${transaction.id}')">
                <i class="fas fa-link"></i> Map
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="ignoreTransaction('${transaction.id}')">
                <i class="fas fa-times"></i> Ignore
            </button>
        `;
    } else {
        return `
            <button class="btn btn-outline-info btn-sm" onclick="reviewTransaction('${transaction.id}')">
                <i class="fas fa-search"></i> Review
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="flagForReview('${transaction.id}')">
                <i class="fas fa-flag"></i> Flag
            </button>
        `;
    }
}

// Update quick action panel with statistics
function updateQuickActionPanel(statistics) {
    const quickActions = document.querySelector('.quick-actions');
    if (!quickActions) return;
    
    const actionCounts = {
        'manual-match': statistics.unmatched,
        'review-exceptions': statistics.exceptions,
        'ai-suggestions': statistics.ai_matches,
        'generate-journals': statistics.ai_matches + statistics.manual_matches
    };
    
    Object.entries(actionCounts).forEach(([action, count]) => {
        const button = quickActions.querySelector(`[data-action="${action}"]`);
        if (button) {
            const badge = button.querySelector('.badge');
            if (badge) {
                badge.textContent = count;
            }
        }
    });
}

// Display exceptions in the alert panel
function displayExceptions(exceptions) {
    const container = document.querySelector('.exceptions-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    exceptions.forEach(exception => {
        const alertClass = getExceptionAlertClass(exception.severity);
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show`;
        alert.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${exception.type.replace('_', ' ').toUpperCase()}</div>
                    <div class="small">${exception.description}</div>
                    <div class="small text-muted mt-1">
                        <i class="fas fa-lightbulb me-1"></i>
                        ${exception.recommended_action}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        container.appendChild(alert);
    });
}

// Get exception alert class based on severity
function getExceptionAlertClass(severity) {
    switch(severity) {
        case 'warning': return 'alert-warning';
        case 'info': return 'alert-info';
        case 'secondary': return 'alert-secondary';
        default: return 'alert-danger';
    }
}

// Update activity log
function updateActivityLog(activities) {
    const logContainer = document.querySelector('.activity-log');
    if (!logContainer) return;
    
    logContainer.innerHTML = '';
    
    activities.forEach(activity => {
        const activityIcon = getActivityIcon(activity.type);
        const activityClass = getActivityClass(activity.type);
        
        const logEntry = document.createElement('div');
        logEntry.className = `activity-entry d-flex align-items-start mb-3`;
        logEntry.innerHTML = `
            <div class="activity-icon ${activityClass} me-3">
                <i class="fas ${activityIcon}"></i>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold">${activity.user}</div>
                <div class="small">${activity.action}</div>
                <div class="small text-muted">${activity.timestamp}</div>
            </div>
        `;
        logContainer.appendChild(logEntry);
    });
}

// Get activity icon based on type
function getActivityIcon(type) {
    switch(type) {
        case 'ai': return 'fa-robot';
        case 'manual': return 'fa-user';
        case 'system': return 'fa-cog';
        default: return 'fa-info-circle';
    }
}

// Get activity class based on type
function getActivityClass(type) {
    switch(type) {
        case 'ai': return 'text-success';
        case 'manual': return 'text-primary';
        case 'system': return 'text-info';
        default: return 'text-secondary';
    }
}

// Update batch controls
function updateBatchControls(statistics) {
    const batchStatus = document.querySelector('.batch-status');
    if (batchStatus) {
        const isLocked = statistics.processing_date ? true : false;
        batchStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isLocked ? 'fa-lock' : 'fa-unlock'} me-2"></i>
                <span>Batch ${isLocked ? 'Locked' : 'Unlocked'}</span>
            </div>
        `;
    }
}

// Update summary counters
function updateSummaryCounters(statistics) {
    const counters = {
        'total-transactions': statistics.total_transactions,
        'matched-amount': `â‚¹${statistics.matched_amount.toLocaleString()}`,
        'unmatched-amount': `â‚¹${statistics.unmatched_amount.toLocaleString()}`,
        'confidence-rate': `${statistics.confidence_rate}%`
    };
    
    Object.entries(counters).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
}



// Load demo data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load demo data for bank reconciliation testing
    setTimeout(loadDemoReconciliationData, 1000);
});

// Advanced invoice search functionality
function searchInvoicesAdvanced(transactionId, searchTerm) {
    if (searchTerm.length < 2) {
        document.getElementById(`invoiceResults_${transactionId}`).innerHTML = '';
        return;
    }
    
    fetch(`/api/search-invoices-advanced?term=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            displayInvoiceSearchResults(transactionId, data.results || []);
        })
        .catch(error => {
            console.error('Error searching invoices:', error);
            document.getElementById(`invoiceResults_${transactionId}`).innerHTML = 
                '<div class="text-danger small">Error searching invoices</div>';
        });
}

function showAllInvoicesAdvanced(transactionId) {
    fetch('/api/get-all-invoices')
        .then(response => response.json())
        .then(data => {
            displayInvoiceSearchResults(transactionId, data.invoices || []);
        })
        .catch(error => {
            console.error('Error loading invoices:', error);
            document.getElementById(`invoiceResults_${transactionId}`).innerHTML = 
                '<div class="text-danger small">Error loading invoices</div>';
        });
}

function displayInvoiceSearchResults(transactionId, invoices) {
    const container = document.getElementById(`invoiceResults_${transactionId}`);
    
    if (!invoices || invoices.length === 0) {
        container.innerHTML = '<div class="text-muted small">No invoices found</div>';
        return;
    }
    
    let html = '<div class="invoice-options">';
    
    invoices.forEach(invoice => {
        const confidence = calculateMappingConfidence(transactionId, invoice);
        const badgeClass = getConfidenceBadgeClass(confidence);
        
        html += `
            <div class="invoice-option border rounded p-2 mb-2 cursor-pointer" 
                 onclick="selectInvoiceForMapping('${transactionId}', '${invoice.id}', ${confidence})"
                 style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${invoice.invoice_number}</div>
                        <div class="text-muted small">${invoice.party_name}</div>
                        <div class="small">â‚¹${parseFloat(invoice.amount).toFixed(2)} | ${invoice.date}</div>
                        <div class="text-muted small">${invoice.description || 'No description'}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass}">${Math.round(confidence)}%</span>
                        <div class="small text-muted mt-1">${getConfidenceLabel(confidence)}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function calculateMappingConfidence(transactionId, invoice) {
    // Get transaction data from the current unmapped transactions
    const transaction = getCurrentTransaction(transactionId);
    if (!transaction) return 0;
    
    let totalScore = 0;
    const weights = {
        amount: 0.35,
        date: 0.25,
        reference: 0.20,
        party: 0.15,
        description: 0.05
    };
    
    // Amount matching with GST consideration
    const amountDiff = Math.abs(Math.abs(transaction.amount) - parseFloat(invoice.amount));
    const maxAmount = Math.max(Math.abs(transaction.amount), parseFloat(invoice.amount));
    const amountScore = maxAmount > 0 ? Math.max(0, 1 - amountDiff / maxAmount) : 0;
    totalScore += amountScore * weights.amount;
    
    // Date proximity
    const transactionDate = new Date(transaction.date);
    const invoiceDate = new Date(invoice.date);
    const daysDiff = Math.abs(transactionDate - invoiceDate) / (1000 * 60 * 60 * 24);
    const dateScore = daysDiff === 0 ? 1 : Math.max(0, 1 - daysDiff / 30);
    totalScore += dateScore * weights.date;
    
    // Reference matching
    const refScore = transaction.reference && invoice.invoice_number && 
                    transaction.reference.toLowerCase().includes(invoice.invoice_number.toLowerCase()) ? 0.8 : 0;
    totalScore += refScore * weights.reference;
    
    // Party name matching
    const partyWords = invoice.party_name.toLowerCase().split(' ');
    const descWords = transaction.description.toLowerCase().split(' ');
    const matchingWords = partyWords.filter(word => word.length > 2 && descWords.some(dw => dw.includes(word)));
    const partyScore = partyWords.length > 0 ? matchingWords.length / partyWords.length : 0;
    totalScore += partyScore * weights.party;
    
    return Math.min(100, totalScore * 100);
}

function getConfidenceBadgeClass(confidence) {
    if (confidence >= 95) return 'bg-success';
    if (confidence >= 80) return 'bg-primary';
    if (confidence >= 60) return 'bg-warning';
    if (confidence >= 40) return 'bg-secondary';
    return 'bg-danger';
}

function getConfidenceLabel(confidence) {
    if (confidence >= 95) return 'Perfect';
    if (confidence >= 80) return 'High';
    if (confidence >= 60) return 'Moderate';
    if (confidence >= 40) return 'Low';
    return 'Poor';
}

function selectInvoiceForMapping(transactionId, invoiceId, confidence) {
    // Update hidden fields
    document.getElementById(`selectedInvoice_${transactionId}`).value = invoiceId;
    document.getElementById(`selectedConfidence_${transactionId}`).value = confidence;
    
    // Show confidence analysis
    showConfidenceAnalysis(transactionId, confidence);
    
    // Highlight selected invoice
    const invoiceOptions = document.querySelectorAll(`#invoiceResults_${transactionId} .invoice-option`);
    invoiceOptions.forEach(option => option.classList.remove('border-primary', 'bg-light'));
    
    event.target.closest('.invoice-option').classList.add('border-primary', 'bg-light');
    
    showAlert(`Invoice selected with ${Math.round(confidence)}% confidence`, 'info');
}

function showConfidenceAnalysis(transactionId, overallConfidence) {
    const analysisDiv = document.getElementById(`confidenceAnalysis_${transactionId}`);
    if (!analysisDiv) return;
    
    analysisDiv.style.display = 'block';
    
    // Simulate individual factor scores based on overall confidence
    const factors = {
        amount: Math.min(100, Math.max(0, overallConfidence + (Math.random() * 20 - 10))),
        date: Math.min(100, Math.max(0, overallConfidence + (Math.random() * 20 - 10))),
        reference: Math.min(100, Math.max(0, overallConfidence + (Math.random() * 30 - 15))),
        party: Math.min(100, Math.max(0, overallConfidence + (Math.random() * 20 - 10)))
    };
    
    // Update progress bars
    const amountBar = document.getElementById(`amountScore_${transactionId}`);
    const dateBar = document.getElementById(`dateScore_${transactionId}`);
    const referenceBar = document.getElementById(`referenceScore_${transactionId}`);
    const partyBar = document.getElementById(`partyScore_${transactionId}`);
    
    if (amountBar) amountBar.style.width = `${factors.amount}%`;
    if (dateBar) dateBar.style.width = `${factors.date}%`;
    if (referenceBar) referenceBar.style.width = `${factors.reference}%`;
    if (partyBar) partyBar.style.width = `${factors.party}%`;
    
    // Update overall score
    const overallBar = document.getElementById(`overallScore_${transactionId}`);
    const overallBadge = document.getElementById(`confidenceBadge_${transactionId}`);
    
    if (overallBar) {
        overallBar.style.width = `${overallConfidence}%`;
        overallBar.className = `progress-bar ${getConfidenceBadgeClass(overallConfidence)}`;
    }
    
    if (overallBadge) {
        overallBadge.textContent = `${Math.round(overallConfidence)}%`;
        overallBadge.className = `badge ${getConfidenceBadgeClass(overallConfidence)}`;
    }
}

function submitAdvancedMapping(event, transactionId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Professional Mapping...';
    submitBtn.disabled = true;
    
    const mappingData = {
        transaction_id: transactionId,
        account_code: formData.get('account_code'),
        selected_invoice_id: formData.get('selected_invoice_id'),
        confidence_score: formData.get('confidence_score'),
        notes: formData.get('notes')
    };
    
    fetch('/api/bank-reconciliation/advanced-mapping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Professional mapping created successfully with journal entry!', 'success');
            refreshReconciliation();
        } else {
            showAlert(data.message || 'Failed to create professional mapping', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Network error occurred during mapping', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function flagForReview(transactionId) {
    const notes = prompt('Please provide reason for flagging this transaction for management review:');
    if (!notes) return;
    
    fetch('/api/bank-reconciliation/flag-review', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            transaction_id: transactionId,
            notes: notes,
            flagged_by: 'current_user'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Transaction flagged for management review', 'warning');
            refreshReconciliation();
        } else {
            showAlert('Failed to flag transaction', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error flagging transaction', 'error');
    });
}

function ignoreTransaction(transactionId) {
    if (!confirm('Are you sure you want to mark this transaction as ignored? This can be undone later.')) {
        return;
    }
    
    fetch('/api/bank-reconciliation/ignore-transaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            transaction_id: transactionId,
            ignored_by: 'current_user',
            reason: 'Manual ignore'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Transaction marked as ignored', 'info');
            refreshReconciliation();
        } else {
            showAlert('Failed to ignore transaction', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error ignoring transaction', 'error');
    });
}

function getCurrentTransaction(transactionId) {
    // Try to find the transaction in current unmapped transactions
    const unmatchedContainer = document.getElementById('unmatchedTransactions');
    if (unmatchedContainer) {
        const transactionCard = unmatchedContainer.querySelector(`[data-transaction-id="${transactionId}"]`);
        if (transactionCard) {
            // Extract transaction data from the DOM
            return {
                transaction_id: transactionId,
                date: transactionCard.dataset.date || '2024-01-15',
                amount: parseFloat(transactionCard.dataset.amount) || 0,
                description: transactionCard.dataset.description || '',
                reference: transactionCard.dataset.reference || ''
            };
        }
    }
    
    // Fallback to sample data structure
    return {
        transaction_id: transactionId,
        date: '2024-01-15',
        amount: 50000,
        description: 'Bank transaction for mapping',
        reference: 'REF123'
    };
}

function showBankReconciliationError(error) {
    document.getElementById('reconciliationStatus').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${error}
        </div>
    `;
}

function showMappingSuccess(transactionId) {
    const form = document.getElementById(`mappingForm_${transactionId}`);
    form.innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check me-2"></i>
            Transaction mapped successfully!
        </div>
    `;
}

function showMappingError(error) {
    // Show error message in a toast or alert
    alert('Mapping Error: ' + error);
}

function showProcessingSuccess(data) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check me-2"></i>
        Successfully processed ${data.processed_count} matched transactions to ledger.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('#reconciliationTable').prepend(alert);
}

function showProcessingError(error) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        Error processing transactions: ${error}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('#reconciliationTable').prepend(alert);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN');
}

// Advanced Invoice Mapping Functions
function searchInvoices(transactionId, searchTerm) {
    if (searchTerm.length < 2) {
        document.getElementById(`invoiceResults_${transactionId}`).innerHTML = '';
        return;
    }
    
    // Show loading indicator
    document.getElementById(`invoiceResults_${transactionId}`).innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Searching invoices...</span>
        </div>
    `;
    
    // Simulate API call to search invoices
    fetch(`/api/bank-reconciliation/search-invoices?query=${encodeURIComponent(searchTerm)}`)
    .then(response => response.json())
    .then(data => {
        displayInvoiceSearchResults(transactionId, data.invoices || []);
    })
    .catch(error => {
        document.getElementById(`invoiceResults_${transactionId}`).innerHTML = `
            <div class="alert alert-warning alert-sm">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Search temporarily unavailable
            </div>
        `;
    });
}

function displayInvoiceSearchResults(transactionId, invoices) {
    const container = document.getElementById(`invoiceResults_${transactionId}`);
    
    if (invoices.length === 0) {
        container.innerHTML = '<p class="text-muted small">No matching invoices found</p>';
        return;
    }
    
    let html = '<div class="invoice-search-results">';
    invoices.forEach(invoice => {
        html += `
            <div class="invoice-result-item border rounded p-2 mb-2 cursor-pointer" 
                 onclick="selectInvoiceForMapping('${transactionId}', '${invoice.id}', '${invoice.invoice_number}', '${invoice.party_name}', ${invoice.amount})">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${invoice.invoice_number}</strong>
                        <br><small class="text-muted">${invoice.party_name}</small>
                        <br><span class="text-info">â‚¹${invoice.amount.toFixed(2)}</span>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${formatDate(invoice.date)}</small>
                        <br><span class="badge bg-outline-primary">${invoice.status}</span>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function selectInvoiceForMapping(transactionId, invoiceId, invoiceNumber, partyName, amount) {
    // Update hidden input
    document.getElementById(`selectedInvoice_${transactionId}`).value = invoiceId;
    
    // Show selection feedback
    document.getElementById(`invoiceResults_${transactionId}`).innerHTML = `
        <div class="alert alert-success alert-sm">
            <i class="fas fa-check me-1"></i>
            Selected: <strong>${invoiceNumber}</strong> - ${partyName} (â‚¹${amount.toFixed(2)})
        </div>
    `;
    
    // Clear account selection since we're mapping to invoice
    const accountSelect = document.querySelector(`#mappingForm_${transactionId} select[name="account_code"]`);
    if (accountSelect) accountSelect.value = '';
}

function showAllInvoices(transactionId) {
    fetch('/api/bank-reconciliation/available-invoices')
    .then(response => response.json())
    .then(data => {
        displayInvoiceSearchResults(transactionId, data.invoices || []);
    })
    .catch(error => {
        console.error('Error fetching invoices:', error);
    });
}

function submitAdvancedMapping(event, transactionId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating mapping...';
    submitBtn.disabled = true;
    
    const mappingData = {
        transaction_id: transactionId,
        invoice_id: formData.get('invoice_id'),
        account_code: formData.get('account_code'),
        notes: formData.get('notes'),
        mapping_type: formData.get('invoice_id') ? 'invoice' : 'account'
    };
    
    fetch('/api/bank-reconciliation/create-advanced-mapping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAdvancedMappingSuccess(transactionId, data);
            // Refresh reconciliation results
            refreshReconciliation();
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error creating mapping: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function viewMatchDetails(transactionId) {
    fetch(`/api/bank-reconciliation/match-details/${transactionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMatchDetailsModal(data.details);
        }
    })
    .catch(error => {
        console.error('Error fetching match details:', error);
    });
}

function reviewPartialMatch(transactionId) {
    // Open modal for reviewing partial matches
    fetch(`/api/bank-reconciliation/partial-match-details/${transactionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPartialMatchReviewModal(transactionId, data.suggestions);
        }
    })
    .catch(error => {
        console.error('Error fetching partial match details:', error);
    });
}

function confirmPartialMatch(transactionId) {
    const confirmBtn = event.target;
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Confirming...';
    confirmBtn.disabled = true;
    
    fetch(`/api/bank-reconciliation/confirm-partial-match/${transactionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMappingSuccess(transactionId);
            refreshReconciliation();
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error confirming match: ' + error.message);
    })
    .finally(() => {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

function ignoreTransaction(transactionId) {
    if (!confirm('Are you sure you want to ignore this transaction? It will not be included in journal entries.')) {
        return;
    }
    
    fetch(`/api/bank-reconciliation/ignore-transaction/${transactionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove transaction card
            const transactionCard = document.querySelector(`#mappingForm_${transactionId}`).closest('.col-lg-6');
            transactionCard.remove();
            
            showAlert('success', 'Transaction ignored successfully');
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error ignoring transaction: ' + error.message);
    });
}

function displayProcessingSummary(results) {
    const summaryContainer = document.getElementById('reconciliationStatus');
    
    const matched = results.filter(r => r.status === 'matched').length;
    const partial = results.filter(r => r.status === 'partial').length;
    const unmatched = results.filter(r => r.status === 'unmatched').length;
    const total = results.length;
    
    const matchPercentage = ((matched + partial * 0.5) / total * 100).toFixed(1);
    
    summaryContainer.innerHTML = `
        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Processing Summary</h6>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${(matched/total*100)}%"></div>
                            <div class="progress-bar bg-warning" style="width: ${(partial/total*100)}%"></div>
                            <div class="progress-bar bg-danger" style="width: ${(unmatched/total*100)}%"></div>
                        </div>
                        <small class="text-muted">
                            ${matchPercentage}% successfully processed â€¢ 
                            ${matched} auto-matched â€¢ 
                            ${partial} need review â€¢ 
                            ${unmatched} require manual mapping
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title">Ready for Journal</h6>
                        <div class="h4 text-success">${matched}</div>
                        <button class="btn btn-success btn-sm" onclick="processReadyTransactions()" 
                                ${matched === 0 ? 'disabled' : ''}>
                            <i class="fas fa-check me-1"></i>Process ${matched} Transactions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function processReadyTransactions() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating journal entries...';
    button.disabled = true;
    
    fetch('/api/bank-reconciliation/process-ready-transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Successfully created ${data.journal_entries_count} journal entries`);
            refreshReconciliation();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error processing transactions: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showAdvancedMappingSuccess(transactionId, data) {
    const form = document.getElementById(`mappingForm_${transactionId}`);
    form.innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check me-2"></i>
            <strong>Mapping Created Successfully!</strong><br>
            ${data.journal_entry ? `Journal Entry: ${data.journal_entry.entry_id}` : 'Account mapping completed'}
        </div>
    `;
}

function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function refreshReconciliation() {
    // Refresh the reconciliation results by re-submitting the bank statement
    const form = document.getElementById('bankStatementForm');
    if (form) {
        // Check if we have existing data to refresh
        const fileInput = form.querySelector('input[type="file"]');
        if (fileInput && fileInput.files.length > 0) {
            submitBankStatement();
        }
    }
}

function showMappingError(error) {
    showAlert('danger', 'Mapping Error: ' + error);
}

function showMappingSuccess(transactionId) {
    const form = document.getElementById(`mappingForm_${transactionId}`);
    if (form) {
        form.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check me-2"></i>
                <strong>Transaction Processed Successfully!</strong>
            </div>
        `;
    }
}

// Event Listeners for Bank Reconciliation
document.addEventListener('DOMContentLoaded', function() {
    // Bank statement form submission
    const bankForm = document.getElementById('bankStatementForm');
    if (bankForm) {
        bankForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitBankStatement();
        });
    }
    
    // Add invoice search result click styles
    const style = document.createElement('style');
    style.textContent = `
        .invoice-result-item:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #e3f2fd;
            cursor: pointer;
        }
    `;
    document.head.appendChild(style);
});

function clearJournalForm() {
    if (confirm('Are you sure you want to clear all journal entries?')) {
        document.getElementById('manualJournalForm').reset();
        
        // Reset to single entry
        const container = document.getElementById('journalEntries');
        container.innerHTML = `
            <div class="journal-entry-row row g-2 mb-2" data-entry="1">
                <div class="col-md-3">
                    <select class="form-select account-select" name="account_code[]" required>
                        <option value="">Select Account...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" name="description[]" placeholder="Description" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control debit-amount" name="debit_amount[]" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control credit-amount" name="credit_amount[]" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="col-md-1">
                    <small class="accounting-effect text-muted">-</small>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-entry" disabled>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        populateAccountDropdowns();
        updateJournalTotals();
        updateEntryCount();
        
        // Clear results
        document.getElementById('journalResults').style.display = 'none';
        document.getElementById('accountingRulesStatus').innerHTML = '';
    }
}

function loadCommonTemplates() {
    const templateModal = `
        <div class="modal fade" id="templateModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Common Journal Entry Templates</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Cash Sale</h6>
                                        <p class="card-text small">Record cash sale transaction</p>
                                        <button class="btn btn-sm btn-primary" onclick="loadTemplate('cash_sale')">Load Template</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Purchase Invoice</h6>
                                        <p class="card-text small">Record purchase on credit</p>
                                        <button class="btn btn-sm btn-primary" onclick="loadTemplate('purchase_credit')">Load Template</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Payment to Supplier</h6>
                                        <p class="card-text small">Pay accounts payable</p>
                                        <button class="btn btn-sm btn-primary" onclick="loadTemplate('pay_supplier')">Load Template</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Expense Payment</h6>
                                        <p class="card-text small">Pay business expense</p>
                                        <button class="btn btn-sm btn-primary" onclick="loadTemplate('expense_payment')">Load Template</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page if not exists
    if (!document.getElementById('templateModal')) {
        document.body.insertAdjacentHTML('beforeend', templateModal);
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

function loadTemplate(templateType) {
    const templates = {
        cash_sale: [
            { account: '1000', description: 'Cash sale', debit: 1000, credit: 0 },
            { account: '4000', description: 'Sales revenue', debit: 0, credit: 1000 }
        ],
        purchase_credit: [
            { account: '5000', description: 'Purchase', debit: 500, credit: 0 },
            { account: '2010', description: 'Accounts payable', debit: 0, credit: 500 }
        ],
        pay_supplier: [
            { account: '2010', description: 'Payment to supplier', debit: 500, credit: 0 },
            { account: '1000', description: 'Cash payment', debit: 0, credit: 500 }
        ],
        expense_payment: [
            { account: '5100', description: 'Office expense', debit: 200, credit: 0 },
            { account: '1000', description: 'Cash payment', debit: 0, credit: 200 }
        ]
    };
    
    const template = templates[templateType];
    if (!template) return;
    
    // Clear existing entries
    clearJournalForm();
    
    // Load template entries
    const container = document.getElementById('journalEntries');
    container.innerHTML = '';
    
    template.forEach((entry, index) => {
        const entryRow = document.createElement('div');
        entryRow.className = 'journal-entry-row row g-2 mb-2';
        entryRow.setAttribute('data-entry', index + 1);
        
        entryRow.innerHTML = `
            <div class="col-md-3">
                <select class="form-select account-select" name="account_code[]" required>
                    <option value="">Select Account...</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="description[]" value="${entry.description}" required>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control debit-amount" name="debit_amount[]" value="${entry.debit || ''}" step="0.01" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control credit-amount" name="credit_amount[]" value="${entry.credit || ''}" step="0.01" min="0">
            </div>
            <div class="col-md-1">
                <small class="accounting-effect text-muted">-</small>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm remove-entry" ${index === 0 ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(entryRow);
    });
    
    // Populate dropdowns and set selected values
    populateAccountDropdowns();
    setTimeout(() => {
        template.forEach((entry, index) => {
            const selectElement = container.children[index].querySelector('.account-select');
            selectElement.value = entry.account;
            updateAccountingEffect(selectElement);
        });
        updateJournalTotals();
        updateEntryCount();
    }, 100);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
    if (modal) modal.hide();
}

// Manual Mapping Functions with Journal Integration
function performManualMapping(transactionId) {
    const accountSelect = document.getElementById(`account_${transactionId}`);
    const notesInput = document.getElementById(`notes_${transactionId}`);
    
    const selectedAccount = accountSelect.value;
    const notes = notesInput.value;
    
    if (!selectedAccount) {
        alert('Please select an account for mapping');
        return;
    }
    
    // Show loading state
    const mapButton = event.target;
    const originalText = mapButton.innerHTML;
    mapButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Mapping...';
    mapButton.disabled = true;
    
    // Prepare mapping data
    const mappingData = {
        transaction_id: transactionId,
        account_code: selectedAccount,
        notes: notes,
        mapping_type: 'manual'
    };
    
    // Post to backend for journal entry creation
    fetch('/api/bank-reconciliation/manual-map', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMappingSuccess(transactionId, data);
            // Refresh reconciliation results
            updateReconciliationDisplay();
            // Show journal entry confirmation
            showJournalEntryCreated(data.journal_entry);
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error during manual mapping: ' + error.message);
    })
    .finally(() => {
        mapButton.innerHTML = originalText;
        mapButton.disabled = false;
    });
}

function suggestAccounts(transactionId) {
    const suggestions = [
        { code: '1200', name: 'Accounts Receivable', confidence: 85, reason: 'Common for customer payments' },
        { code: '5200', name: 'Bank Charges', confidence: 70, reason: 'Frequent bank transaction' },
        { code: '1900', name: 'Suspense Account', confidence: 60, reason: 'Default for unclassified' }
    ];
    
    const suggestionsDiv = document.getElementById(`suggestions_${transactionId}`);
    
    let html = '';
    suggestions.forEach(suggestion => {
        html += `
            <a href="#" class="list-group-item list-group-item-action" 
               onclick="selectSuggestedAccount('${transactionId}', '${suggestion.code}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${suggestion.code} - ${suggestion.name}</h6>
                    <small class="text-success">${suggestion.confidence}% match</small>
                </div>
                <small class="text-muted">${suggestion.reason}</small>
            </a>
        `;
    });
    
    suggestionsDiv.querySelector('.list-group').innerHTML = html;
    suggestionsDiv.style.display = 'block';
}

function selectSuggestedAccount(transactionId, accountCode) {
    const accountSelect = document.getElementById(`account_${transactionId}`);
    accountSelect.value = accountCode;
    
    // Hide suggestions
    const suggestionsDiv = document.getElementById(`suggestions_${transactionId}`);
    suggestionsDiv.style.display = 'none';
    
    // Highlight the selected suggestion
    accountSelect.style.borderColor = '#28a745';
    accountSelect.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
}

function showMappingSuccess(transactionId, data) {
    // Create success notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle me-2"></i>
            <div>
                <strong>Transaction Mapped Successfully!</strong><br>
                <small>Journal entry created and posted to ledger</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Update the transaction card to show mapped status
    updateTransactionCardToMapped(transactionId, data);
}

function showJournalEntryCreated(journalEntry) {
    // Show journal entry confirmation notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.top = '70px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-journal-whills me-2"></i>
            <div>
                <strong>Journal Entry Posted!</strong><br>
                <small>Entry ${journalEntry.reference} created in general ledger</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 6000);
}

function updateTransactionCardToMapped(transactionId, data) {
    // Find and update the transaction card to show mapped status
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        if (card.innerHTML.includes(transactionId)) {
            card.className = 'card border-success bg-success bg-opacity-10';
            const header = card.querySelector('.card-header');
            if (header) {
                header.className = 'card-header bg-success text-white';
                header.innerHTML = '<h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Successfully Mapped</h6>';
            }
        }
    });
}

function showMappingError(error) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Mapping Failed!</strong><br>
                <small>${error}</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function removeJournalEntry(button) {
    const entry = button.closest('.journal-entry-row');
    entry.remove();
    updateJournalTotals();
}

function updateJournalTotals() {
    const debits = document.querySelectorAll('.debit-amount');
    const credits = document.querySelectorAll('.credit-amount');
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    debits.forEach(input => {
        totalDebits += parseFloat(input.value) || 0;
    });
    
    credits.forEach(input => {
        totalCredits += parseFloat(input.value) || 0;
    });
    
    document.getElementById('totalDebits').textContent = `â‚¹${totalDebits.toFixed(2)}`;
    document.getElementById('totalCredits').textContent = `â‚¹${totalCredits.toFixed(2)}`;
    
    const balance = totalDebits - totalCredits;
    const balanceElement = document.getElementById('entryBalance');
    balanceElement.textContent = `â‚¹${Math.abs(balance).toFixed(2)}`;
    balanceElement.className = balance === 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
    
    // Update validation status
    const statusDiv = document.getElementById('validationStatus');
    if (balance === 0 && totalDebits > 0) {
        statusDiv.innerHTML = `
            <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                Entry is balanced and ready to save
            </div>
        `;
    } else if (balance !== 0) {
        statusDiv.innerHTML = `
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Entry is not balanced (Difference: â‚¹${Math.abs(balance).toFixed(2)})
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Add entries to see validation
            </div>
        `;
    }
}

function processManualJournal() {
    const form = document.getElementById('manualJournalForm');
    const formData = new FormData(form);
    
    fetch('/api/manual-journal', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Journal entry saved successfully!');
            form.reset();
            updateJournalTotals();
        } else {
            alert('Error: ' + (data.error || 'Failed to save journal entry'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function validateJournalEntry() {
    const entries = [];
    const rows = document.querySelectorAll('.journal-entry-row');
    
    rows.forEach(row => {
        const accountCode = row.querySelector('[name="account_code[]"]').value;
        const description = row.querySelector('[name="description[]"]').value;
        const debitAmount = row.querySelector('[name="debit_amount[]"]').value;
        const creditAmount = row.querySelector('[name="credit_amount[]"]').value;
        
        if (accountCode && description && (debitAmount || creditAmount)) {
            entries.push({
                account_code: accountCode,
                description: description,
                debit_amount: parseFloat(debitAmount) || 0,
                credit_amount: parseFloat(creditAmount) || 0
            });
        }
    });
    
    fetch('/api/manual-journal/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({entries: entries})
    })
    .then(response => response.json())
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('validationModal'));
        document.getElementById('validationModalBody').innerHTML = `
            <h6>Validation Results:</h6>
            <p><strong>Balance Check:</strong> ${data.is_balanced ? 'Passed' : 'Failed'}</p>
            <p><strong>Total Debits:</strong> â‚¹${data.total_debits}</p>
            <p><strong>Total Credits:</strong> â‚¹${data.total_credits}</p>
            ${data.warnings ? `<div class="alert alert-warning">${data.warnings.join('<br>')}</div>` : ''}
        `;
        modal.show();
    })
    .catch(error => {
        alert('Validation error: ' + error.message);
    });
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('F-AI Accountant Dashboard loaded');
    
    // Bank Statement Form
    const bankForm = document.getElementById('bankStatementForm');
    if (bankForm) {
        bankForm.addEventListener('submit', function(e) {
            e.preventDefault();
            processBankStatement();
        });
    }
    
    // Manual Journal Form
    const journalForm = document.getElementById('manualJournalForm');
    if (journalForm) {
        journalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            processManualJournal();
        });
        
        // Set default date
        const dateInput = document.getElementById('journalDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    }
    
    // Add Journal Entry Button
    const addButton = document.getElementById('addJournalEntry');
    if (addButton) {
        addButton.addEventListener('click', addJournalEntry);
    }
    
    // Validate Journal Button
    const validateButton = document.getElementById('validateJournal');
    if (validateButton) {
        validateButton.addEventListener('click', validateJournalEntry);
    }
    
    // Remove Entry Buttons (Delegation)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-entry')) {
            removeJournalEntry(e.target.closest('.remove-entry'));
        }
    });
    
    // Amount Input Changes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('debit-amount') || e.target.classList.contains('credit-amount')) {
            updateJournalTotals();
        }
    });
    
    // Load chart of accounts
    loadChartOfAccounts();
});

// Demo function to show unmapped transactions for manual mapping
function showDemoUnmappedTransactions() {
    // Sample unmapped transactions that require manual mapping
    const unmappedTransactions = [
        {
            transaction_id: 'TXN003',
            date: '2024-01-17',
            description: 'Unknown Transfer - Office Equipment',
            amount: -15000,
            type: 'debit',
            status: 'unmatched',
            confidence: 0,
            match_details: null
        },
        {
            transaction_id: 'TXN004',
            date: '2024-01-18',
            description: 'RTGS Receipt from Client XYZ',
            amount: 35000,
            type: 'credit',
            status: 'unmatched',
            confidence: 0,
            match_details: null
        },
        {
            transaction_id: 'TXN005',
            date: '2024-01-19',
            description: 'Bank Charges and Fees',
            amount: -500,
            type: 'debit',
            status: 'unmatched',
            confidence: 0,
            match_details: null
        }
    ];

    const doubtfulTransactions = [
        {
            transaction_id: 'TXN006',
            date: '2024-01-20',
            description: 'Partial Payment - Vendor ABC',
            amount: -8000,
            type: 'debit',
            status: 'partial',
            confidence: 65,
            match_details: 'Partial match with multiple invoices'
        }
    ];

    const mappedTransactions = [
        {
            transaction_id: 'TXN001',
            date: '2024-01-15',
            description: 'NEFT Payment from Client ABC',
            amount: 50000,
            type: 'credit',
            status: 'matched',
            confidence: 95,
            match_details: 'Matched with Invoice INV-001'
        },
        {
            transaction_id: 'TXN002',
            date: '2024-01-16',
            description: 'Salary Payment',
            amount: -25000,
            type: 'debit',
            status: 'matched',
            confidence: 90,
            match_details: 'Matched with Payroll Entry'
        }
    ];

    // Show the manual mapping section
    document.getElementById('manualMappingSection').style.display = 'block';
    document.getElementById('reconciliationResults').style.display = 'block';
    
    // Update statistics
    document.getElementById('matchedCount').textContent = mappedTransactions.length;
    document.getElementById('partialCount').textContent = doubtfulTransactions.length;
    document.getElementById('unmatchedCount').textContent = unmappedTransactions.length;
    
    // Display color-coded transactions with manual mapping interface
    displayColorCodedTransactions(mappedTransactions, doubtfulTransactions, unmappedTransactions);
    
    // Update the status message
    document.getElementById('reconciliationStatus').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Demo Active:</strong> Manual mapping interface now visible below
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetDemo()">
            <i class="fas fa-refresh me-1"></i>Reset Demo
        </button>
    `;
}

function resetDemo() {
    document.getElementById('manualMappingSection').style.display = 'none';
    document.getElementById('reconciliationResults').style.display = 'none';
    document.getElementById('reconciliationStatus').innerHTML = `
        <p class="text-muted">Upload bank statement to begin reconciliation</p>
        <button class="btn btn-primary btn-sm mt-2" onclick="showDemoUnmappedTransactions()">
            <i class="fas fa-play me-1"></i>Demo Manual Mapping
        </button>
    `;
}

function submitAdvancedMapping(event, transactionId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Get form values
    const accountCode = formData.get('account_code');
    const notes = formData.get('notes');
    
    if (!accountCode) {
        alert('Please select an account for mapping');
        return;
    }
    
    // Show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Journal Entry...';
    submitBtn.disabled = true;
    
    // Prepare mapping data
    const mappingData = {
        transaction_id: transactionId,
        account_code: accountCode,
        notes: notes,
        mapping_type: 'manual'
    };
    
    // Submit to backend
    fetch('/api/bank-reconciliation/manual-map', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMappingSuccess(transactionId, data);
            // Update transaction card to show mapped status
            updateTransactionCardToMapped(transactionId, data);
        } else {
            showMappingError(data.error);
        }
    })
    .catch(error => {
        showMappingError('Error during manual mapping: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Function to display color-coded transactions with manual mapping interface
function displayColorCodedTransactions(mappedTransactions, doubtfulTransactions, unmappedTransactions) {
    const unmatchedContainer = document.getElementById('unmatchedTransactions');
    
    let html = '<h6 class="mb-3">Unmapped Transactions Requiring Manual Mapping</h6>';
    
    // Display unmapped transactions with red color coding
    unmappedTransactions.forEach(transaction => {
        html += `
            <div class="transaction-card mb-3" style="border-left: 4px solid #dc3545; background-color: #fff5f5;">
                <div class="card">
                    <div class="card-header" style="background-color: #f8d7da; color: #721c24;">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-0">
                                    <span class="badge bg-danger me-2">UNMAPPED</span>
                                    ${transaction.description}
                                </h6>
                                <small class="text-muted">${transaction.date} | ${transaction.transaction_id}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <strong class="${transaction.amount >= 0 ? 'text-success' : 'text-danger'}">
                                    â‚¹${Math.abs(transaction.amount).toLocaleString()}
                                </strong>
                                <br>
                                <small class="text-muted">${transaction.type.toUpperCase()}</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form onsubmit="submitAdvancedMapping(event, '${transaction.transaction_id}')">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="account_${transaction.transaction_id}" class="form-label">
                                        <i class="fas fa-chart-line me-1"></i>Select Account
                                    </label>
                                    <select name="account_code" id="account_${transaction.transaction_id}" class="form-select" required>
                                        <option value="">Choose account...</option>
                                        <optgroup label="Assets">
                                            <option value="1000">1000 - Cash Account</option>
                                            <option value="1020">1020 - Bank Account - Current</option>
                                            <option value="1100">1100 - Accounts Receivable</option>
                                            <option value="1200">1200 - Inventory</option>
                                            <option value="1400">1400 - Fixed Assets</option>
                                            <option value="1900">1900 - Suspense Account</option>
                                        </optgroup>
                                        <optgroup label="Liabilities">
                                            <option value="2010">2010 - Accounts Payable</option>
                                            <option value="2200">2200 - Tax Liabilities</option>
                                        </optgroup>
                                        <optgroup label="Revenue">
                                            <option value="4000">4000 - Sales Revenue</option>
                                            <option value="4100">4100 - Interest Income</option>
                                            <option value="4200">4200 - Rental Income</option>
                                        </optgroup>
                                        <optgroup label="Expenses">
                                            <option value="5100">5100 - Operating Expenses</option>
                                            <option value="5110">5110 - Salaries and Wages</option>
                                            <option value="5120">5120 - Rent Expense</option>
                                            <option value="5200">5200 - Bank Charges</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="notes_${transaction.transaction_id}" class="form-label">
                                        <i class="fas fa-sticky-note me-1"></i>Notes (Optional)
                                    </label>
                                    <input type="text" name="notes" id="notes_${transaction.transaction_id}" 
                                           class="form-control" placeholder="Add mapping notes...">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="fas fa-check me-1"></i>Map Transaction
                                    </button>
                                    <button type="button" class="btn btn-warning me-2" onclick="flagForReview('${transaction.transaction_id}')">
                                        <i class="fas fa-flag me-1"></i>Flag for Review
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="ignoreTransaction('${transaction.transaction_id}')">
                                        <i class="fas fa-times me-1"></i>Ignore
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Display doubtful transactions with yellow color coding
    if (doubtfulTransactions.length > 0) {
        html += '<h6 class="mb-3 mt-4">Doubtful Transactions Requiring Review</h6>';
        
        doubtfulTransactions.forEach(transaction => {
            html += `
                <div class="transaction-card mb-3" style="border-left: 4px solid #ffc107; background-color: #fffbf0;">
                    <div class="card">
                        <div class="card-header" style="background-color: #fff3cd; color: #856404;">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-0">
                                        <span class="badge bg-warning me-2">DOUBTFUL</span>
                                        ${transaction.description}
                                    </h6>
                                    <small class="text-muted">${transaction.date} | ${transaction.transaction_id}</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <strong class="${transaction.amount >= 0 ? 'text-success' : 'text-danger'}">
                                        â‚¹${Math.abs(transaction.amount).toLocaleString()}
                                    </strong>
                                    <br>
                                    <small class="text-muted">Confidence: ${transaction.confidence}%</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Partial Match:</strong> ${transaction.match_details}
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="btn btn-success me-2" onclick="confirmPartialMatch('${transaction.transaction_id}')">
                                        <i class="fas fa-check me-1"></i>Confirm Match
                                    </button>
                                    <button type="button" class="btn btn-warning me-2" onclick="flagForReview('${transaction.transaction_id}')">
                                        <i class="fas fa-flag me-1"></i>Flag for Review
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="ignoreTransaction('${transaction.transaction_id}')">
                                        <i class="fas fa-times me-1"></i>Ignore
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Display mapped transactions with green color coding
    if (mappedTransactions.length > 0) {
        html += '<h6 class="mb-3 mt-4">Successfully Mapped Transactions</h6>';
        
        mappedTransactions.forEach(transaction => {
            html += `
                <div class="transaction-card mb-3" style="border-left: 4px solid #28a745; background-color: #f0fff4;">
                    <div class="card">
                        <div class="card-header" style="background-color: #d4edda; color: #155724;">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-0">
                                        <span class="badge bg-success me-2">MAPPED</span>
                                        ${transaction.description}
                                    </h6>
                                    <small class="text-muted">${transaction.date} | ${transaction.transaction_id}</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <strong class="${transaction.amount >= 0 ? 'text-success' : 'text-danger'}">
                                        â‚¹${Math.abs(transaction.amount).toLocaleString()}
                                    </strong>
                                    <br>
                                    <small class="text-muted">Confidence: ${transaction.confidence}%</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Matched:</strong> ${transaction.match_details}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    unmatchedContainer.innerHTML = html;
}

// Helper functions for manual mapping actions
function flagForReview(transactionId) {
    if (confirm('Flag this transaction for manual review?')) {
        // Simulate flagging for review
        alert('Transaction flagged for review successfully!');
    }
}

function ignoreTransaction(transactionId) {
    if (confirm('Ignore this transaction? It will be excluded from reconciliation.')) {
        // Simulate ignoring transaction
        alert('Transaction ignored successfully!');
    }
}

function confirmPartialMatch(transactionId) {
    if (confirm('Confirm this partial match?')) {
        // Simulate confirming partial match
        alert('Partial match confirmed successfully!');
    }
}

function showMappingSuccess(transactionId, data) {
    alert(`âœ… Transaction ${transactionId} mapped successfully!\n\nJournal Entry Created:\n${data.journal_entry ? JSON.stringify(data.journal_entry, null, 2) : 'Details not available'}`);
}

function showMappingError(error) {
    alert(`âŒ Mapping failed: ${error}`);
}

function updateTransactionCardToMapped(transactionId, data) {
    // Update the transaction card to show mapped status
    const transactionCard = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    if (transactionCard) {
        transactionCard.style.borderLeft = '4px solid #28a745';
        transactionCard.style.backgroundColor = '#f0fff4';
        // Update content to show mapped status
        const badge = transactionCard.querySelector('.badge');
        if (badge) {
            badge.className = 'badge bg-success me-2';
            badge.textContent = 'MAPPED';
        }
    }
}

// ===== ENHANCED WORKFLOW MANAGEMENT FUNCTIONS =====

// Load journal entries list
function loadJournalEntriesList() {
    fetch('/api/manual-journal/entries-list')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentJournalEntries = data.entries;
            updateJournalEntriesTable(data.entries);
            updateJournalCounts(data.entries);
        }
    })
    .catch(error => {
        console.error('Error loading journal entries:', error);
    });
}

// Update journal entries table
function updateJournalEntriesTable(entries) {
    const tbody = document.getElementById('journalEntriesTableBody');
    
    if (entries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>No journal entries found. Create your first entry above.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = entries.map(entry => {
        const statusBadge = getStatusBadge(entry.status);
        const workflowStage = getWorkflowStage(entry.status);
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input journal-checkbox" 
                           value="${entry.id}" onchange="selectJournalEntry(this)">
                </td>
                <td><strong>${entry.journal_number}</strong></td>
                <td>${formatDate(entry.entry_date)}</td>
                <td>${entry.description}</td>
                <td class="text-end">â‚¹${parseFloat(entry.total_debits || 0).toFixed(2)}</td>
                <td>${statusBadge}</td>
                <td>${entry.created_by_name || 'System'}</td>
                <td>
                    <small class="text-muted">${workflowStage}</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="quickEditJournal(${entry.id})" title="Quick Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" 
                                onclick="viewJournalDetails(${entry.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="deleteJournal(${entry.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'draft': '<span class="badge bg-secondary">Draft</span>',
        'pending_review': '<span class="badge bg-warning">Pending Review</span>',
        'reviewed': '<span class="badge bg-info">Reviewed</span>',
        'approved': '<span class="badge bg-success">Approved</span>',
        'posted': '<span class="badge bg-primary">Posted</span>',
        'rejected': '<span class="badge bg-danger">Rejected</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

// Get workflow stage description
function getWorkflowStage(status) {
    const stages = {
        'draft': 'Creation Stage',
        'pending_review': 'Review Stage',
        'reviewed': 'Approval Stage',
        'approved': 'Ready to Post',
        'posted': 'Completed',
        'rejected': 'Returned for Revision'
    };
    return stages[status] || 'Unknown Stage';
}

// Update journal counts
function updateJournalCounts(entries) {
    const totalCount = entries.length;
    const pendingCount = entries.filter(e => ['pending_review', 'reviewed'].includes(e.status)).length;
    
    document.getElementById('journalCount').textContent = totalCount;
    document.getElementById('pendingCount').textContent = pendingCount;
}

// Select journal entry
function selectJournalEntry(checkbox) {
    const checkboxes = document.querySelectorAll('.journal-checkbox');
    checkboxes.forEach(cb => {
        if (cb !== checkbox) cb.checked = false;
    });
    
    selectedJournalId = checkbox.checked ? parseInt(checkbox.value) : null;
}

// Workflow action functions
function createNewJournal() {
    clearJournalForm();
    document.getElementById('manualJournalForm').scrollIntoView({ behavior: 'smooth' });
}

function editSelectedJournal() {
    if (!selectedJournalId) {
        alert('Please select a journal entry to edit.');
        return;
    }
    
    const entry = currentJournalEntries.find(e => e.id === selectedJournalId);
    if (entry && entry.status === 'draft') {
        loadJournalForEdit(selectedJournalId);
    } else {
        alert('Only draft entries can be edited.');
    }
}

function reviewSelectedJournal() {
    if (!selectedJournalId) {
        alert('Please select a journal entry to review.');
        return;
    }
    
    updateJournalStatus(selectedJournalId, 'pending_review');
}

function approveSelectedJournal() {
    if (!selectedJournalId) {
        alert('Please select a journal entry to approve.');
        return;
    }
    
    const entry = currentJournalEntries.find(e => e.id === selectedJournalId);
    if (entry && ['pending_review', 'reviewed'].includes(entry.status)) {
        updateJournalStatus(selectedJournalId, 'approved');
    } else {
        alert('Entry must be reviewed before approval.');
    }
}

function rejectSelectedJournal() {
    if (!selectedJournalId) {
        alert('Please select a journal entry to reject.');
        return;
    }
    
    const reason = prompt('Enter rejection reason:');
    if (reason) {
        updateJournalStatus(selectedJournalId, 'rejected', reason);
    }
}

function deleteSelectedJournal() {
    if (!selectedJournalId) {
        alert('Please select a journal entry to delete.');
        return;
    }
    
    if (confirm('Are you sure you want to delete this journal entry? This action cannot be undone.')) {
        deleteJournal(selectedJournalId);
    }
}

// Update journal status
function updateJournalStatus(journalId, newStatus, reason = null) {
    const data = { 
        journal_id: journalId, 
        status: newStatus 
    };
    
    if (reason) {
        data.reason = reason;
    }
    
    fetch('/api/manual-journal/update-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatusUpdateSuccess(newStatus);
            loadJournalEntriesList();
            
            // Show posted entries if approved
            if (newStatus === 'approved') {
                setTimeout(showPostedEntriesFloat, 1000);
            }
        } else {
            alert('Error updating status: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error updating status: ' + error.message);
    });
}

// Show status update success
function showStatusUpdateSuccess(status) {
    const statusText = status.replace('_', ' ').toUpperCase();
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            Journal entry successfully ${statusText}!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert at top of workflow management card
    const workflowCard = document.querySelector('.card-body');
    workflowCard.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        const alert = workflowCard.querySelector('.alert');
        if (alert) alert.remove();
    }, 3000);
}

// Delete journal
function deleteJournal(journalId) {
    fetch(`/api/manual-journal/delete/${journalId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Journal entry deleted successfully.');
            loadJournalEntriesList();
            selectedJournalId = null;
        } else {
            alert('Error deleting journal: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting journal: ' + error.message);
    });
}

// Quick edit and view functions
function quickEditJournal(journalId) {
    viewJournalDetails(journalId);
}

function viewJournalDetails(journalId) {
    fetch(`/api/manual-journal/details/${journalId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showJournalDetailsModal(data.journal);
        } else {
            alert('Error loading journal details: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error loading journal details: ' + error.message);
    });
}

// Show journal details modal
function showJournalDetailsModal(journal) {
    const modalHtml = `
        <div class="modal fade" id="journalDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-alt me-2"></i>Journal Entry Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Journal Number:</strong> ${journal.journal_number}
                            </div>
                            <div class="col-md-6">
                                <strong>Date:</strong> ${formatDate(journal.entry_date)}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Status:</strong> ${getStatusBadge(journal.status)}
                            </div>
                            <div class="col-md-6">
                                <strong>Total Amount:</strong> â‚¹${parseFloat(journal.total_debits || 0).toFixed(2)}
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Description:</strong><br>
                            ${journal.description}
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Account</th>
                                        <th>Description</th>
                                        <th>Debit</th>
                                        <th>Credit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${journal.lines ? journal.lines.map(line => `
                                        <tr>
                                            <td>${line.account_code}</td>
                                            <td>${line.line_description}</td>
                                            <td class="text-end">â‚¹${parseFloat(line.debit_amount || 0).toFixed(2)}</td>
                                            <td class="text-end">â‚¹${parseFloat(line.credit_amount || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4" class="text-center">No line items</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        ${journal.status === 'draft' ? '<button type="button" class="btn btn-primary" onclick="editJournalFromModal(' + journal.id + ')">Edit</button>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('journalDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('journalDetailsModal'));
    modal.show();
}

// Refresh and filter functions
function refreshJournalList() {
    loadJournalEntriesList();
}

function showJournalFilters() {
    alert('Filter functionality coming soon!');
}

// ===== POSTED ENTRIES FLOATING DISPLAY =====

// Show posted entries floating display
function showPostedEntriesFloat() {
    loadPostedEntries();
    document.getElementById('postedEntriesFloat').style.display = 'block';
}

// Hide posted entries floating display
function hidePostedEntriesFloat() {
    document.getElementById('postedEntriesFloat').style.display = 'none';
}

// Load posted entries
function loadPostedEntries() {
    fetch('/api/manual-journal/posted-entries')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePostedEntriesTable(data.entries);
            updateLastUpdatedTime();
        }
    })
    .catch(error => {
        console.error('Error loading posted entries:', error);
    });
}

// Update posted entries table
function updatePostedEntriesTable(entries) {
    const tbody = document.getElementById('postedEntriesTableBody');
    
    if (entries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>No posted entries found.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = entries.map(entry => `
        <tr>
            <td><strong>${entry.journal_number}</strong></td>
            <td>${formatDateTime(entry.posted_at)}</td>
            <td>${entry.description}</td>
            <td class="text-end">â‚¹${parseFloat(entry.total_debits || 0).toFixed(2)}</td>
            <td>${entry.posted_by_name || 'System'}</td>
            <td><span class="badge bg-success">Posted</span></td>
        </tr>
    `).join('');
}

// Start auto-refresh for posted entries
function startPostedEntriesAutoRefresh() {
    postedEntriesRefreshInterval = setInterval(() => {
        const floatDiv = document.getElementById('postedEntriesFloat');
        if (floatDiv.style.display !== 'none') {
            loadPostedEntries();
        }
    }, 30000); // Refresh every 30 seconds
}

// Update last updated time
function updateLastUpdatedTime() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
}

// Show/hide functions
function showJournalList() {
    const workflowCard = document.querySelector('#journalEntriesTable').closest('.card');
    workflowCard.scrollIntoView({ behavior: 'smooth' });
}

function showPostingTracker() {
    showPostedEntriesFloat();
}

// Format date helpers
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

// Load journal for edit
function loadJournalForEdit(journalId) {
    fetch(`/api/manual-journal/details/${journalId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateJournalForm(data.journal);
            document.getElementById('manualJournalForm').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Error loading journal for edit: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error loading journal for edit: ' + error.message);
    });
}

// Populate journal form with existing data
function populateJournalForm(journal) {
    document.getElementById('journalDate').value = journal.entry_date.split('T')[0];
    document.getElementById('journalReference').value = journal.reference_number || '';
    document.getElementById('journalDescription').value = journal.description || '';
    document.getElementById('journalType').value = journal.source_type || 'manual';
    
    // Clear existing entries
    const container = document.getElementById('journalEntries');
    container.innerHTML = '';
    
    // Add journal lines
    if (journal.lines && journal.lines.length > 0) {
        journal.lines.forEach(line => {
            addJournalEntry();
            const lastEntry = container.lastElementChild;
            lastEntry.querySelector('select[name="account_code[]"]').value = line.account_code;
            lastEntry.querySelector('input[name="description[]"]').value = line.line_description;
            lastEntry.querySelector('input[name="debit_amount[]"]').value = line.debit_amount || '';
            lastEntry.querySelector('input[name="credit_amount[]"]').value = line.credit_amount || '';
        });
    } else {
        addJournalEntry(); // Add at least one entry
    }
    
    updateJournalTotals();
}

// Edit journal from modal
function editJournalFromModal(journalId) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('journalDetailsModal'));
    modal.hide();
    loadJournalForEdit(journalId);
}

// ===============================================
// COMPREHENSIVE LEDGER LIBRARY INTEGRATION
// ===============================================

let ledgerLibrary = {};
let accountSearchTimeout = null;

// Initialize ledger library on page load
async function initializeLedgerLibrary() {
    try {
        const response = await fetch('/api/manual-journal/ledger-library');
        const data = await response.json();
        
        if (data.success) {
            ledgerLibrary = data.library;
            console.log('âœ… Ledger library loaded:', Object.keys(ledgerLibrary).length, 'categories');
        } else {
            console.error('âŒ Failed to load ledger library:', data.message);
        }
    } catch (error) {
        console.error('âŒ Error loading ledger library:', error);
    }
}

// Enhanced account search with ledger library integration
function setupAccountSearch(inputElement) {
    inputElement.addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim();
        const dropdown = e.target.nextElementSibling;
        
        clearTimeout(accountSearchTimeout);
        
        if (searchTerm.length < 2) {
            dropdown.classList.add('d-none');
            return;
        }
        
        accountSearchTimeout = setTimeout(() => {
            searchLedgerAccounts(searchTerm, dropdown, e.target);
        }, 300);
    });
    
    inputElement.addEventListener('blur', function(e) {
        // Delay hiding dropdown to allow clicks
        setTimeout(() => {
            const dropdown = e.target.nextElementSibling;
            dropdown.classList.add('d-none');
        }, 200);
    });
    
    inputElement.addEventListener('focus', function(e) {
        if (e.target.value.trim().length >= 2) {
            const dropdown = e.target.nextElementSibling;
            searchLedgerAccounts(e.target.value.trim(), dropdown, e.target);
        }
    });
}

// Search ledger accounts with intelligent matching
async function searchLedgerAccounts(searchTerm, dropdown, inputElement) {
    try {
        const response = await fetch(`/api/manual-journal/search-accounts?term=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();
        
        if (data.success) {
            displayAccountSearchResults(data.accounts, dropdown, inputElement);
        } else {
            dropdown.innerHTML = '<div class="p-2 text-muted">No accounts found</div>';
            dropdown.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error searching accounts:', error);
        dropdown.innerHTML = '<div class="p-2 text-danger">Search error</div>';
        dropdown.classList.remove('d-none');
    }
}

// Display account search results with smart suggestions
function displayAccountSearchResults(accounts, dropdown, inputElement) {
    if (!accounts || accounts.length === 0) {
        dropdown.innerHTML = `
            <div class="p-2 text-muted">
                <i class="fas fa-search me-1"></i>No matching accounts found
                <hr class="my-2">
                <small class="text-info">
                    <i class="fas fa-plus me-1"></i>Click the + button to create new account
                </small>
            </div>
        `;
        dropdown.classList.remove('d-none');
        return;
    }
    
    let html = '';
    accounts.forEach(account => {
        const confidence = account.confidence || 0;
        const badgeClass = confidence >= 90 ? 'bg-success' : confidence >= 70 ? 'bg-warning' : 'bg-secondary';
        
        html += `
            <div class="account-suggestion p-2 border-bottom cursor-pointer hover-bg-light" 
                 onclick="selectAccount('${account.code}', '${account.name}', '${account.type}', '${inputElement.name}')">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="text-primary">${account.code}</strong>
                        <span class="ms-2">${account.name}</span>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-tag me-1"></i>${account.type}
                            ${account.balance !== undefined ? `â€¢ Balance: â‚¹${account.balance.toFixed(2)}` : ''}
                        </small>
                    </div>
                    <span class="badge ${badgeClass} small">${confidence}%</span>
                </div>
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
    dropdown.classList.remove('d-none');
}

// Select account from dropdown
function selectAccount(code, name, type, inputName) {
    const input = document.querySelector(`input[name="${inputName}"]`);
    if (input) {
        input.value = `${code} - ${name}`;
        input.setAttribute('data-account-code', code);
        input.setAttribute('data-account-type', type);
        
        // Hide dropdown
        const dropdown = input.nextElementSibling;
        dropdown.classList.add('d-none');
        
        // Update accounting effect
        updateAccountingEffectForRow(input);
        
        // Trigger validation
        updateJournalTotals();
    }
}

// Show create account modal
function showCreateAccountModal(buttonElement) {
    const inputElement = buttonElement.previousElementSibling.previousElementSibling;
    const searchTerm = inputElement.value.trim();
    
    // Pre-populate modal with search term
    document.getElementById('newAccountName').value = searchTerm;
    
    // Store reference to input for callback
    window.currentAccountInput = inputElement;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('createAccountModal'));
    modal.show();
}

// Create new ledger account
async function createNewLedgerAccount() {
    const form = document.getElementById('createAccountForm');
    const formData = new FormData(form);
    
    const accountData = {
        code: formData.get('account_code'),
        name: formData.get('account_name'),
        type: formData.get('account_type'),
        description: formData.get('account_description'),
        opening_balance: parseFloat(formData.get('opening_balance')) || 0
    };
    
    const submitBtn = document.getElementById('submitNewAccount');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/api/ledger-library/create-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the input field with new account
            if (window.currentAccountInput) {
                window.currentAccountInput.value = `${data.account.code} - ${data.account.name}`;
                window.currentAccountInput.setAttribute('data-account-code', data.account.code);
                window.currentAccountInput.setAttribute('data-account-type', data.account.type);
                
                updateAccountingEffectForRow(window.currentAccountInput);
            }
            
            // Refresh ledger library
            await initializeLedgerLibrary();
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('createAccountModal')).hide();
            
            // Show success message
            showAlert('Account created successfully!', 'success');
            
            // Reset form
            form.reset();
            
        } else {
            showAlert(data.message || 'Failed to create account', 'error');
        }
    } catch (error) {
        console.error('Error creating account:', error);
        showAlert('Error creating account', 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Suggest account code based on type and name
async function suggestAccountCode() {
    const accountType = document.getElementById('newAccountType').value;
    const accountName = document.getElementById('newAccountName').value;
    
    if (!accountType || !accountName) return;
    
    try {
        const response = await fetch('/api/ledger-library/suggest-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: accountType,
                name: accountName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('newAccountCode').value = data.suggested_code;
        }
    } catch (error) {
        console.error('Error suggesting account code:', error);
    }
}

// Update accounting effect for specific row
function updateAccountingEffectForRow(inputElement) {
    const row = inputElement.closest('.journal-entry-row');
    if (!row) return;
    
    const accountCode = inputElement.getAttribute('data-account-code');
    const accountType = inputElement.getAttribute('data-account-type');
    const effectElement = row.querySelector('.accounting-effect');
    
    if (!accountCode || !accountType || !effectElement) return;
    
    let effectText = '';
    let effectClass = 'accounting-effect text-muted';
    
    switch (accountType.toLowerCase()) {
        case 'assets':
        case 'expenses':
            effectText = 'â†‘ Dr / â†“ Cr';
            effectClass = 'accounting-effect text-primary';
            break;
        case 'liabilities':
        case 'equity':
        case 'revenue':
        case 'income':
            effectText = 'â†“ Dr / â†‘ Cr';
            effectClass = 'accounting-effect text-success';
            break;
        default:
            effectText = '-';
    }
    
    effectElement.textContent = effectText;
    effectElement.className = effectClass;
}

// Enhanced add journal entry with account search
function addJournalEntryEnhanced() {
    const container = document.getElementById('journalEntries');
    const entryCount = container.children.length + 1;
    
    const row = document.createElement('div');
    row.className = 'journal-entry-row row g-2 mb-2';
    row.setAttribute('data-entry', entryCount);
    
    row.innerHTML = `
        <div class="col-md-3">
            <div class="position-relative">
                <input type="text" class="form-control account-search" name="account_code[]" 
                       placeholder="Search account code or name..." autocomplete="off" required>
                <div class="account-dropdown position-absolute w-100 bg-white border border-top-0 rounded-bottom d-none" 
                     style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                </div>
                <button type="button" class="btn btn-sm btn-outline-success position-absolute end-0 top-0" 
                        style="margin: 2px;" onclick="showCreateAccountModal(this)" title="Create New Account">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="description[]" placeholder="Description" required>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control debit-amount" name="debit_amount[]" 
                   placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control credit-amount" name="credit_amount[]" 
                   placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="col-md-1">
            <small class="accounting-effect text-muted">-</small>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm remove-entry" 
                    onclick="removeJournalEntry(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(row);
    
    // Setup account search for new input
    const newInput = row.querySelector('.account-search');
    setupAccountSearch(newInput);
    
    // Update entry numbers
    updateRemoveButtons();
    updateJournalTotals();
}

// Enhanced journal form initialization
function initializeEnhancedJournalForm() {
    // Initialize ledger library
    initializeLedgerLibrary();
    
    // Setup account search for existing inputs
    document.querySelectorAll('.account-search').forEach(input => {
        setupAccountSearch(input);
    });
    
    // Add event listeners for account type changes in create modal
    const accountTypeSelect = document.getElementById('newAccountType');
    const accountNameInput = document.getElementById('newAccountName');
    
    if (accountTypeSelect) {
        accountTypeSelect.addEventListener('change', suggestAccountCode);
    }
    
    if (accountNameInput) {
        accountNameInput.addEventListener('input', suggestAccountCode);
    }
    
    // Override original addJournalEntry function
    if (typeof addJournalEntry === 'function') {
        window.originalAddJournalEntry = addJournalEntry;
        window.addJournalEntry = addJournalEntryEnhanced;
    }
}

// Initialize enhanced features when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedJournalForm();
    
    // Initialize Sample Reports KYC functionality
    initializeSampleReportsKYC();
});

// =====================================
// SAMPLE REPORTS & KYC FUNCTIONALITY
// =====================================

// Store KYC setup data
let kycData = null;

// Initialize Sample Reports KYC functionality
function initializeSampleReportsKYC() {
    // Load KYC data if available
    const savedKYC = localStorage.getItem('kycSetupData');
    if (savedKYC) {
        try {
            kycData = JSON.parse(savedKYC);
            updateKYCStatus();
            enableCustomReportButtons();
        } catch (error) {
            console.error('Error loading saved KYC data:', error);
        }
    }
}

// Show KYC Setup Modal (Global function)
window.showKYCSetupModal = function() {
    const modal = new bootstrap.Modal(document.getElementById('kycSetupModal'));
    
    // Load existing KYC data if available
    loadExistingKYCData();
    
    modal.show();
}

// Load existing KYC data from localStorage
function loadExistingKYCData() {
    const savedKYC = localStorage.getItem('kycSetupData');
    if (savedKYC) {
        try {
            const data = JSON.parse(savedKYC);
            
            // Populate form fields
            document.getElementById('companyName').value = data.companyName || '';
            document.getElementById('companyType').value = data.companyType || 'private_limited';
            document.getElementById('registrationNumber').value = data.registrationNumber || '';
            document.getElementById('gstNumber').value = data.gstNumber || '';
            document.getElementById('address').value = data.address || '';
            document.getElementById('city').value = data.city || '';
            document.getElementById('state').value = data.state || '';
            document.getElementById('pincode').value = data.pincode || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('financialYearStart').value = data.financialYearStart || '';
            document.getElementById('financialYearEnd').value = data.financialYearEnd || '';
            document.getElementById('reportFooter').value = data.reportFooter || '';
            
        } catch (error) {
            console.error('Error loading KYC data:', error);
        }
    }
}

// Save KYC Setup - Global function
window.saveKYCSetup = function() {
    const form = document.getElementById('kycSetupForm');
    
    // Validate required fields
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect form data
    kycData = {
        companyName: document.getElementById('companyName').value,
        companyType: document.getElementById('companyType').value,
        registrationNumber: document.getElementById('registrationNumber').value,
        gstNumber: document.getElementById('gstNumber').value,
        address: document.getElementById('address').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        pincode: document.getElementById('pincode').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        financialYearStart: document.getElementById('financialYearStart').value,
        financialYearEnd: document.getElementById('financialYearEnd').value,
        reportFooter: document.getElementById('reportFooter').value,
        setupDate: new Date().toISOString()
    };
    
    // Save to localStorage
    localStorage.setItem('kycSetupData', JSON.stringify(kycData));
    
    // Update KYC status display
    updateKYCStatus();
    
    // Enable custom report generation buttons
    enableCustomReportButtons();
    
    // Show success message
    showNotification('KYC setup saved successfully! You can now generate customized reports.', 'success');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('kycSetupModal'));
    modal.hide();
}

// Update KYC status display
function updateKYCStatus() {
    const statusElement = document.getElementById('kyc-status');
    if (kycData) {
        statusElement.innerHTML = `KYC Setup: <strong>${kycData.companyName}</strong> - Ready for customized reports`;
        statusElement.parentElement.className = 'alert alert-success d-flex align-items-center';
    } else {
        statusElement.innerHTML = 'KYC Setup: <strong>Default Template</strong> - Click "Setup KYC" to customize client branding';
        statusElement.parentElement.className = 'alert alert-info d-flex align-items-center';
    }
}

// Enable custom report generation buttons
function enableCustomReportButtons() {
    const customButtons = [
        'journal-custom', 'ledger-custom', 'trial_balance-custom', 
        'profit_loss-custom', 'balance_sheet-custom', 'cash_flow-custom',
        'shareholders_equity-custom', 'mis_report-custom'
    ];
    
    customButtons.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = false;
            button.classList.remove('btn-outline-secondary');
        }
    });
}

// Generate sample report (preview) - Global function
window.generateSampleReport = function(reportType) {
    showNotification(`Generating sample ${reportType} report...`, 'info');
    
    // Simulate report generation
    setTimeout(() => {
        const reportNames = {
            'journal': 'Journal Report',
            'ledger': 'Ledger Report',
            'trial_balance': 'Trial Balance',
            'profit_loss': 'P&L Statement',
            'balance_sheet': 'Balance Sheet',
            'cash_flow': 'Cash Flow Statement',
            'shareholders_equity': 'Shareholders\' Equity',
            'mis_report': 'MIS Report'
        };
        
        showNotification(`${reportNames[reportType]} sample generated successfully! This preview shows the default template format.`, 'success');
        
        // You can add actual download functionality here
        console.log(`Sample ${reportType} report generated`);
        
    }, 1500);
}

// Generate custom report with KYC data - Global function
window.generateCustomReport = function(reportType) {
    if (!kycData) {
        showNotification('Please setup KYC information first to generate customized reports.', 'warning');
        showKYCSetupModal();
        return;
    }
    
    showNotification(`Generating customized ${reportType} report for ${kycData.companyName}...`, 'info');
    
    // Simulate custom report generation with KYC data
    setTimeout(() => {
        const reportNames = {
            'journal': 'Journal Report',
            'ledger': 'Ledger Report',
            'trial_balance': 'Trial Balance',
            'profit_loss': 'P&L Statement',
            'balance_sheet': 'Balance Sheet',
            'cash_flow': 'Cash Flow Statement',
            'shareholders_equity': 'Shareholders\' Equity',
            'mis_report': 'MIS Report'
        };
        
        showNotification(`Customized ${reportNames[reportType]} generated successfully for ${kycData.companyName}!`, 'success');
        
        // You can add actual download functionality here
        console.log(`Custom ${reportType} report generated with KYC data:`, kycData);
        
    }, 2000);
}

// Enhanced Bank Reconciliation Functions
function showAdvancedFeatures() {
    document.getElementById('advancedReconciliationFeatures').style.display = 'block';
    document.getElementById('transactionMatchingResults').style.display = 'block';
    document.getElementById('reconciliationReport').style.display = 'block';
    
    // Initialize dashboard components
    initializeReconciliationChart();
    updateDashboardStatistics();
    checkForExceptions();
}

function populateTransactionTable(transactions) {
    const tbody = document.getElementById('transactionTableBody');
    tbody.innerHTML = '';
    
    transactions.forEach((tx, index) => {
        const row = document.createElement('tr');
        row.className = getRowClass(tx.status);
        row.innerHTML = `
            <td>${formatDate(tx.date)}</td>
            <td>${tx.description}</td>
            <td class="${tx.amount >= 0 ? 'text-success' : 'text-danger'}">â‚¹${Math.abs(tx.amount).toLocaleString()}</td>
            <td>${getStatusBadge(tx.status)}</td>
            <td>${getConfidenceBar(tx.confidence)}</td>
            <td>${tx.matched_invoice || '-'}</td>
            <td>
                ${getActionButtons(tx, index)}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getRowClass(status) {
    switch(status) {
        case 'matched': return 'table-success';
        case 'unmatched': return 'table-warning';
        case 'doubtful': return 'table-danger';
        default: return '';
    }
}

function getStatusBadge(status) {
    const badges = {
        'matched': '<span class="badge bg-success">Matched</span>',
        'unmatched': '<span class="badge bg-warning">Unmatched</span>',
        'doubtful': '<span class="badge bg-danger">Doubtful</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function getConfidenceBar(confidence) {
    const color = confidence >= 90 ? 'success' : confidence >= 70 ? 'warning' : 'danger';
    return `
        <div class="progress" style="height: 20px;">
            <div class="progress-bar bg-${color}" role="progressbar" 
                 style="width: ${confidence}%" aria-valuenow="${confidence}" 
                 aria-valuemin="0" aria-valuemax="100">${confidence}%</div>
        </div>
    `;
}

function getActionButtons(tx, index) {
    let buttons = '';
    if (tx.status === 'unmatched' || tx.status === 'doubtful') {
        buttons += `<button class="btn btn-sm btn-warning me-1" onclick="mapTransaction(${index})">
                        <i class="fas fa-edit"></i> Map
                    </button>`;
    }
    buttons += `<button class="btn btn-sm btn-info" onclick="viewTransactionDetails(${index})">
                    <i class="fas fa-eye"></i> View
                </button>`;
    return buttons;
}

function filterTransactions(status) {
    const rows = document.querySelectorAll('#transactionTableBody tr');
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else {
            const statusBadge = row.querySelector('.badge');
            const rowStatus = statusBadge.textContent.toLowerCase();
            row.style.display = rowStatus === status ? '' : 'none';
        }
    });
}

function mapTransaction(index) {
    // Get transaction data
    const row = document.querySelectorAll('#transactionTableBody tr')[index];
    const cells = row.querySelectorAll('td');
    
    // Populate selected transaction display
    const selectedTxDiv = document.getElementById('selectedTransaction');
    selectedTxDiv.innerHTML = `
        <div class="mb-2"><strong>Date:</strong> ${cells[0].textContent}</div>
        <div class="mb-2"><strong>Description:</strong> ${cells[1].textContent}</div>
        <div class="mb-2"><strong>Amount:</strong> ${cells[2].textContent}</div>
        <div class="mb-2"><strong>Status:</strong> ${cells[3].innerHTML}</div>
    `;
    
    // Show manual mapping interface
    document.getElementById('manualMappingInterface').style.display = 'block';
    
    // Store transaction index for later use
    window.currentMappingIndex = index;
    
    // Scroll to mapping interface
    document.getElementById('manualMappingInterface').scrollIntoView({ behavior: 'smooth' });
}

function performManualMapping() {
    const accountMapping = document.getElementById('accountMapping').value;
    const mappingDescription = document.getElementById('mappingDescription').value;
    
    if (!accountMapping) {
        showAlert('Please select an account for mapping', 'warning');
        return;
    }
    
    const mappingData = {
        transaction_index: window.currentMappingIndex,
        account_code: accountMapping,
        description: mappingDescription,
        mapping_type: 'manual'
    };
    
    fetch('/api/bank-reconciliation/manual-map', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(mappingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the transaction row
            updateTransactionRow(window.currentMappingIndex, data.updated_transaction);
            
            // Hide mapping interface
            cancelManualMapping();
            
            // Show success message
            showAlert('Transaction mapped successfully!', 'success');
            
            // Update reconciliation stats
            updateReconciliationStats();
        } else {
            showAlert('Error mapping transaction: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error mapping transaction: ' + error.message, 'danger');
        console.error('Error:', error);
    });
}

function cancelManualMapping() {
    document.getElementById('manualMappingInterface').style.display = 'none';
    document.getElementById('accountMapping').value = '';
    document.getElementById('mappingDescription').value = '';
    document.getElementById('selectedTransaction').innerHTML = '<p class="text-muted">Select a transaction to map</p>';
}

function updateTransactionRow(index, updatedTransaction) {
    const row = document.querySelectorAll('#transactionTableBody tr')[index];
    const cells = row.querySelectorAll('td');
    
    // Update status
    cells[3].innerHTML = getStatusBadge(updatedTransaction.status);
    
    // Update confidence
    cells[4].innerHTML = getConfidenceBar(updatedTransaction.confidence);
    
    // Update matched invoice
    cells[5].textContent = updatedTransaction.matched_invoice || '-';
    
    // Update row class
    row.className = getRowClass(updatedTransaction.status);
    
    // Update action buttons
    cells[6].innerHTML = getActionButtons(updatedTransaction, index);
}

function generateJournalEntries() {
    fetch('/api/bank-reconciliation/generate-journals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Generated ${data.journal_count} journal entries successfully!`, 'success');
            
            // Update reconciliation progress
            updateReconciliationProgressAdvanced();
        } else {
            showAlert('Error generating journal entries: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error generating journal entries: ' + error.message, 'danger');
        console.error('Error:', error);
    });
}

function showManualMapping() {
    const unmatchedRows = document.querySelectorAll('#transactionTableBody tr.table-warning, #transactionTableBody tr.table-danger');
    if (unmatchedRows.length === 0) {
        showAlert('No unmatched transactions found', 'info');
        return;
    }
    
    // Scroll to first unmatched transaction
    unmatchedRows[0].scrollIntoView({ behavior: 'smooth' });
    
    // Highlight unmatched transactions
    unmatchedRows.forEach(row => {
        row.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.5)';
        setTimeout(() => {
            row.style.boxShadow = '';
        }, 3000);
    });
}

function updateReconciliationStats() {
    const rows = document.querySelectorAll('#transactionTableBody tr');
    let matched = 0, unmatched = 0, doubtful = 0;
    
    rows.forEach(row => {
        const statusBadge = row.querySelector('.badge');
        const status = statusBadge.textContent.toLowerCase();
        
        switch(status) {
            case 'matched': matched++; break;
            case 'unmatched': unmatched++; break;
            case 'doubtful': doubtful++; break;
        }
    });
    
    document.getElementById('matchedCount').textContent = matched;
    document.getElementById('unmatchedCount').textContent = unmatched;
    document.getElementById('doubtfulCount').textContent = doubtful;
    document.getElementById('totalCount').textContent = rows.length;
    
    // Update progress bar
    const progress = rows.length > 0 ? (matched / rows.length) * 100 : 0;
    const progressBar = document.getElementById('reconciliationProgress');
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
}

function updateReconciliationProgressAdvanced() {
    updateReconciliationStats();
    
    // Update report amounts
    const rows = document.querySelectorAll('#transactionTableBody tr');
    let matchedAmount = 0, unmatchedAmount = 0;
    
    rows.forEach(row => {
        const statusBadge = row.querySelector('.badge');
        const status = statusBadge.textContent.toLowerCase();
        const amountText = row.cells[2].textContent.replace(/[â‚¹,]/g, '');
        const amount = parseFloat(amountText) || 0;
        
        if (status === 'matched') {
            matchedAmount += amount;
        } else {
            unmatchedAmount += amount;
        }
    });
    
    document.getElementById('reportMatchedAmount').textContent = `â‚¹${matchedAmount.toLocaleString()}`;
    document.getElementById('reportUnmatchedAmount').textContent = `â‚¹${unmatchedAmount.toLocaleString()}`;
    document.getElementById('reportReconciliationDate').textContent = new Date().toLocaleDateString('en-IN');
    document.getElementById('reportAccountName').textContent = document.getElementById('bankAccount').value || 'Selected Account';
}

function refreshReconciliation() {
    // Re-run reconciliation process
    const form = document.getElementById('bankStatementForm');
    if (form && form.querySelector('input[type="file"]').files.length > 0) {
        submitBankStatement();
    } else {
        showAlert('Please upload a bank statement first', 'warning');
    }
}

function exportReconciliation() {
    // Use proper file download instead of popup window
    const link = document.createElement('a');
    link.href = '/api/bank-reconciliation/export';
    link.download = 'bank_reconciliation_export.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadReconciliationReport() {
    // Use proper file download instead of popup window
    const link = document.createElement('a');
    link.href = '/api/bank-reconciliation/report';
    link.download = 'reconciliation_report.pdf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function finalizeReconciliation() {
    if (confirm('Are you sure you want to finalize this reconciliation? This action cannot be undone.')) {
        fetch('/api/bank-reconciliation/finalize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Reconciliation finalized successfully!', 'success');
                
                // Disable editing capabilities
                disableReconciliationEditing();
            } else {
                showAlert('Error finalizing reconciliation: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error finalizing reconciliation: ' + error.message, 'danger');
            console.error('Error:', error);
        });
    }
}

function disableReconciliationEditing() {
    // Disable all mapping buttons
    const mapButtons = document.querySelectorAll('button[onclick^="mapTransaction"]');
    mapButtons.forEach(btn => {
        btn.disabled = true;
        btn.className = btn.className.replace('btn-warning', 'btn-secondary');
    });
    
    // Hide manual mapping interface
    document.getElementById('manualMappingInterface').style.display = 'none';
}

function viewTransactionDetails(index) {
    const row = document.querySelectorAll('#transactionTableBody tr')[index];
    const cells = row.querySelectorAll('td');
    
    const modalContent = `
        <div class="modal fade" id="transactionDetailsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Transaction Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3"><strong>Date:</strong> ${cells[0].textContent}</div>
                        <div class="mb-3"><strong>Description:</strong> ${cells[1].textContent}</div>
                        <div class="mb-3"><strong>Amount:</strong> ${cells[2].textContent}</div>
                        <div class="mb-3"><strong>Status:</strong> ${cells[3].innerHTML}</div>
                        <div class="mb-3"><strong>Confidence:</strong> ${cells[4].innerHTML}</div>
                        <div class="mb-3"><strong>Matched Invoice:</strong> ${cells[5].textContent}</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('transactionDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
    modal.show();
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-IN');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 1050; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Comprehensive Dashboard Support Functions

// Initialize reconciliation status chart
function initializeReconciliationChart() {
    const ctx = document.getElementById('reconciliationChart');
    if (!ctx) return;
    
    window.reconciliationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['AI Matched', 'Manual Matched', 'Unmatched', 'Exceptions'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Update dashboard statistics
function updateDashboardStatistics() {
    // Update reconciliation statistics with sample data
    const stats = {
        aiMatches: Math.floor(Math.random() * 50) + 10,
        manualMatches: Math.floor(Math.random() * 20) + 5,
        exceptions: Math.floor(Math.random() * 10) + 2,
        confidenceRate: Math.floor(Math.random() * 20) + 80,
        matched: Math.floor(Math.random() * 60) + 20,
        unmatched: Math.floor(Math.random() * 15) + 5,
        flagged: Math.floor(Math.random() * 8) + 2
    };
    
    // Update stat displays
    document.getElementById('aiMatchCount').textContent = stats.aiMatches;
    document.getElementById('manualMatchCount').textContent = stats.manualMatches;
    document.getElementById('exceptionCount').textContent = stats.exceptions;
    document.getElementById('confidenceRate').textContent = stats.confidenceRate + '%';
    
    document.getElementById('matchedBadge').textContent = stats.matched + ' Matched';
    document.getElementById('unmatchedBadge').textContent = stats.unmatched + ' Unmatched';
    document.getElementById('flaggedBadge').textContent = stats.flagged + ' Flagged';
    
    // Update chart data
    if (window.reconciliationChart) {
        window.reconciliationChart.data.datasets[0].data = [
            stats.aiMatches, stats.manualMatches, stats.unmatched, stats.exceptions
        ];
        window.reconciliationChart.update();
    }
}

// Quick action functions
function jumpToManualMatch() {
    showAlert('Jumping to manual mapping interface...', 'info');
    // Scroll to manual mapping section if exists
    const manualMappingSection = document.getElementById('manualMappingInterface');
    if (manualMappingSection) {
        manualMappingSection.scrollIntoView({ behavior: 'smooth' });
    }
}

function reviewExceptions() {
    showAlert('Loading exceptions review interface...', 'warning');
    document.getElementById('exceptionsAlert').style.display = 'block';
    document.getElementById('exceptionsAlert').scrollIntoView({ behavior: 'smooth' });
}

function viewAISuggestions() {
    showAlert('Loading AI suggestions...', 'info');
    // This would integrate with existing AI suggestion system
    console.log('AI Suggestions requested');
}

// Filter application
function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    const amountFilter = document.getElementById('amountFilter').value;
    const vendorFilter = document.getElementById('vendorFilter').value;
    
    console.log('Applying filters:', {
        status: statusFilter,
        dateFrom: dateFromFilter,
        dateTo: dateToFilter,
        minAmount: amountFilter,
        vendor: vendorFilter
    });
    
    // This would filter the transaction table
    filterTransactionTable({
        status: statusFilter,
        dateFrom: dateFromFilter,
        dateTo: dateToFilter,
        minAmount: amountFilter,
        vendor: vendorFilter
    });
    
    showAlert('Filters applied successfully', 'info');
}

// Filter transaction table
function filterTransactionTable(filters) {
    const table = document.getElementById('transactionTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        let shouldShow = true;
        
        // Apply status filter
        if (filters.status !== 'all') {
            const statusCell = row.querySelector('.status-badge');
            if (statusCell && !statusCell.textContent.toLowerCase().includes(filters.status)) {
                shouldShow = false;
            }
        }
        
        // Apply vendor filter
        if (filters.vendor) {
            const descriptionCell = row.cells[1];
            if (descriptionCell && !descriptionCell.textContent.toLowerCase().includes(filters.vendor.toLowerCase())) {
                shouldShow = false;
            }
        }
        
        // Apply amount filter
        if (filters.minAmount) {
            const amountCell = row.cells[2];
            if (amountCell) {
                const amount = parseFloat(amountCell.textContent.replace(/[â‚¹,]/g, ''));
                if (amount < parseFloat(filters.minAmount)) {
                    shouldShow = false;
                }
            }
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
}

// Batch control functions
function lockBatch() {
    const batchSelector = document.getElementById('batchSelector');
    const selectedBatch = batchSelector.value;
    
    showAlert(`Batch ${selectedBatch} has been locked successfully`, 'success');
    
    // Update batch selector to show locked status
    const option = batchSelector.querySelector(`option[value="${selectedBatch}"]`);
    if (option && !option.textContent.includes('(Locked)')) {
        option.textContent = option.textContent.replace('(Active)', '(Locked)');
    }
    
    // Add activity log entry
    addActivityLogEntry('System', 'Batch locked', 'info');
}

function exportBatchReport() {
    const batchSelector = document.getElementById('batchSelector');
    const selectedBatch = batchSelector.value;
    
    showAlert(`Generating batch report for ${selectedBatch}...`, 'info');
    
    // Simulate report generation
    setTimeout(() => {
        showAlert('Batch report generated and downloaded successfully', 'success');
        addActivityLogEntry('Admin', 'Batch report exported', 'info');
    }, 2000);
}

// Activity log management
function addActivityLogEntry(user, action, type) {
    const activityLog = document.getElementById('activityLog');
    if (!activityLog) return;
    
    const now = new Date();
    const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    
    const badgeClass = {
        'manual': 'bg-warning',
        'ai': 'bg-success',
        'system': 'bg-info',
        'info': 'bg-info'
    }[type] || 'bg-secondary';
    
    const entry = document.createElement('div');
    entry.className = 'activity-item border-bottom pb-2 mb-2';
    entry.innerHTML = `
        <div class="d-flex justify-content-between">
            <small class="text-muted">${timestamp}</small>
            <span class="badge ${badgeClass}">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
        </div>
        <small>${user} ${action}</small>
    `;
    
    // Insert at the top
    activityLog.insertBefore(entry, activityLog.firstChild);
    
    // Keep only last 10 entries
    const entries = activityLog.querySelectorAll('.activity-item');
    if (entries.length > 10) {
        entries[entries.length - 1].remove();
    }
}

// Update reconciliation statistics with real data
function updateReconciliationStatsAdvanced(data) {
    if (!data) return;
    
    document.getElementById('aiMatchCount').textContent = data.aiMatches || 0;
    document.getElementById('manualMatchCount').textContent = data.manualMatches || 0;
    document.getElementById('exceptionCount').textContent = data.exceptions || 0;
    document.getElementById('confidenceRate').textContent = (data.confidenceRate || 0) + '%';
    
    document.getElementById('matchedBadge').textContent = (data.matched || 0) + ' Matched';
    document.getElementById('unmatchedBadge').textContent = (data.unmatched || 0) + ' Unmatched';
    document.getElementById('flaggedBadge').textContent = (data.flagged || 0) + ' Flagged';
    
    // Update chart
    if (window.reconciliationChart) {
        window.reconciliationChart.data.datasets[0].data = [
            data.aiMatches || 0,
            data.manualMatches || 0, 
            data.unmatched || 0,
            data.exceptions || 0
        ];
        window.reconciliationChart.update();
    }
}

</script>

<!-- Create Account Modal -->
<div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createAccountModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Create New Ledger Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAccountForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="newAccountCode" class="form-label">Account Code</label>
                            <input type="text" class="form-control" id="newAccountCode" name="account_code" 
                                   placeholder="Auto-generated" required>
                            <small class="form-text text-muted">Will be auto-suggested based on type and name</small>
                        </div>
                        <div class="col-md-6">
                            <label for="newAccountType" class="form-label">Account Type</label>
                            <select class="form-select" id="newAccountType" name="account_type" required>
                                <option value="">Select Account Type</option>
                                <option value="assets">Assets</option>
                                <option value="liabilities">Liabilities</option>
                                <option value="equity">Equity</option>
                                <option value="revenue">Revenue</option>
                                <option value="expenses">Expenses</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newAccountName" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="newAccountName" name="account_name" 
                               placeholder="Enter descriptive account name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newAccountDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="newAccountDescription" name="account_description" 
                                  rows="2" placeholder="Additional details about this account"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newOpeningBalance" class="form-label">Opening Balance</label>
                        <input type="number" class="form-control" id="newOpeningBalance" name="opening_balance" 
                               step="0.01" value="0.00">
                        <small class="form-text text-muted">Enter opening balance for this account</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitNewAccount" onclick="createNewLedgerAccount()">
                    <i class="fas fa-save me-1"></i>Create Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KYC Setup Modal -->
<div class="modal fade" id="kycSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-check me-2"></i>Client KYC Setup
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kycSetupForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Company Information</h6>
                            <div class="mb-3">
                                <label for="companyName" class="form-label">Company Name *</label>
                                <input type="text" class="form-control" id="companyName" required 
                                       placeholder="Enter company name">
                            </div>
                            <div class="mb-3">
                                <label for="companyType" class="form-label">Company Type</label>
                                <select class="form-select" id="companyType">
                                    <option value="private_limited">Private Limited</option>
                                    <option value="public_limited">Public Limited</option>
                                    <option value="llp">Limited Liability Partnership</option>
                                    <option value="partnership">Partnership</option>
                                    <option value="sole_proprietorship">Sole Proprietorship</option>
                                    <option value="trust">Trust</option>
                                    <option value="society">Society</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="registrationNumber" class="form-label">Registration Number</label>
                                <input type="text" class="form-control" id="registrationNumber" 
                                       placeholder="CIN/LLPIN/Registration No.">
                            </div>
                            <div class="mb-3">
                                <label for="gstNumber" class="form-label">GST Number</label>
                                <input type="text" class="form-control" id="gstNumber" 
                                       placeholder="Enter GST number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Contact Details</h6>
                            <div class="mb-3">
                                <label for="address" class="form-label">Address *</label>
                                <textarea class="form-control" id="address" rows="3" required 
                                          placeholder="Complete business address"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="city" class="form-label">City *</label>
                                <input type="text" class="form-control" id="city" required 
                                       placeholder="City">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="state" class="form-label">State *</label>
                                        <input type="text" class="form-control" id="state" required 
                                               placeholder="State">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="pincode" class="form-label">Pincode *</label>
                                        <input type="text" class="form-control" id="pincode" required 
                                               placeholder="Pincode">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" 
                                       placeholder="Contact number">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email" 
                                       placeholder="business@company.com">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Financial Year & Reporting</h6>
                            <div class="mb-3">
                                <label for="financialYearStart" class="form-label">Financial Year Start</label>
                                <input type="date" class="form-control" id="financialYearStart">
                            </div>
                            <div class="mb-3">
                                <label for="financialYearEnd" class="form-label">Financial Year End</label>
                                <input type="date" class="form-control" id="financialYearEnd">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Report Customization</h6>
                            <div class="mb-3">
                                <label for="logoUpload" class="form-label">Company Logo (Optional)</label>
                                <input type="file" class="form-control" id="logoUpload" accept="image/*">
                                <small class="form-text text-muted">Upload logo for report headers</small>
                            </div>
                            <div class="mb-3">
                                <label for="reportFooter" class="form-label">Report Footer</label>
                                <textarea class="form-control" id="reportFooter" rows="2" 
                                          placeholder="Custom footer text for reports"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKYCSetup()">
                    <i class="fas fa-save me-1"></i>Save KYC Setup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Journal Entry Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="validationModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}